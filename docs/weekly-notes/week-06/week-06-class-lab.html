<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.24">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Dr.&nbsp;Elizabeth Delmelle">
<meta name="dcterms.date" content="2025-10-14">

<title>Spatial Machine Learning &amp; Advanced Regression – TESS VU - MUSA 5080 PORTFOLIO</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dc55a5b9e770e841cd82e46aadbfb9b0.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-cc1d64809b8ed731f92ea1275fe9f05b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">TESS VU - MUSA 5080 PORTFOLIO</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">HOME</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-weekly-notes" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">WEEKLY NOTES</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-weekly-notes">    
        <li>
    <a class="dropdown-item" href="../../weekly-notes.html">
 <span class="dropdown-text">ALL NOTES</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../weekly-notes/week-01/week-01-notes.html">
 <span class="dropdown-text">WEEK 1: COURSE INTRO</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../weekly-notes/week-02/week-02-notes.html">
 <span class="dropdown-text">WEEK 2: DYPLR BASICS</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../weekly-notes/week-03/week-03-notes.html">
 <span class="dropdown-text">WEEK 3: EXPLORATORY DATA ANALYSIS (EDA) &amp; VISUALIZATION</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../weekly-notes/week-03/week-03-class-lab.html">
 <span class="dropdown-text">IN-CLASS LAB 3</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../weekly-notes/week-04/week-04-notes.html">
 <span class="dropdown-text">WEEK 4: SPATIAL DATA &amp; GIS OPERATIONS IN R</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../weekly-notes/week-04/week-04-class-lab.html">
 <span class="dropdown-text">IN-CLASS LAB 4</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../weekly-notes/week-05/week-05-notes.html">
 <span class="dropdown-text">WEEK 5: PREDICTIVE MODELING WITH LINEAR REGRESSION</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../weekly-notes/week-05/week-05-class-lab.html">
 <span class="dropdown-text">IN-CLASS LAB 5</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../weekly-notes/week-06/week-06-notes.html">
 <span class="dropdown-text">WEEK 6: SPATIAL MACHINE LEARNING &amp; ADVANCED REGRESSION</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-labs" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">LABS</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-labs">    
        <li>
    <a class="dropdown-item" href="../../labs.html">
 <span class="dropdown-text">ALL LABS</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../labs/lab-0/lab-0.html">
 <span class="dropdown-text">IN-CLASS LAB 0: DPLYR BASICS</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../labs/lab-1/lab-1.html">
 <span class="dropdown-text">LAB 1: CENSUS DATA</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../labs/lab-2/Vu_Tessa_Assignment2.html">
 <span class="dropdown-text">LAB 2: HEALTHCARE ACCESS AND EQUITY</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-midterm-project" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">MIDTERM PROJECT</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-midterm-project">    
        <li>
    <a class="dropdown-item" href="../../midterm-project/Cao_Deng_Luu_Rigsby_Stauffer_Vu_Slides.html">
 <span class="dropdown-text">MIDTERM SLIDES</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../midterm-project/Cao_Deng_Luu_Rigsby_Stauffer_Vu_Appendix.html">
 <span class="dropdown-text">MIDTERM APPENDIX</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../../final-project.html"> 
<span class="menu-text">FINAL PROJECT</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#todays-journey" id="toc-todays-journey" class="nav-link active" data-scroll-target="#todays-journey">Today’s Journey</a>
  <ul class="collapse">
  <li><a href="#what-well-cover" id="toc-what-well-cover" class="nav-link" data-scroll-target="#what-well-cover">What We’ll Cover</a></li>
  </ul></li>
  <li><a href="#warm-up-build-a-baseline-model" id="toc-warm-up-build-a-baseline-model" class="nav-link" data-scroll-target="#warm-up-build-a-baseline-model">Warm-Up: Build a Baseline Model</a>
  <ul class="collapse">
  <li><a href="#lets-build-something-simple-together" id="toc-lets-build-something-simple-together" class="nav-link" data-scroll-target="#lets-build-something-simple-together">Let’s Build Something Simple Together</a></li>
  <li><a href="#what-does-this-model-tell-us" id="toc-what-does-this-model-tell-us" class="nav-link" data-scroll-target="#what-does-this-model-tell-us">What Does This Model Tell Us?</a></li>
  <li><a href="#interpreting-our-baseline" id="toc-interpreting-our-baseline" class="nav-link" data-scroll-target="#interpreting-our-baseline">Interpreting Our Baseline</a></li>
  <li><a href="#limitations-of-this-model" id="toc-limitations-of-this-model" class="nav-link" data-scroll-target="#limitations-of-this-model">Limitations of This Model</a></li>
  <li><a href="#lets-add-one-more-feature" id="toc-lets-add-one-more-feature" class="nav-link" data-scroll-target="#lets-add-one-more-feature">Let’s Add One More Feature</a></li>
  <li><a href="#converting-to-spatial-data" id="toc-converting-to-spatial-data" class="nav-link" data-scroll-target="#converting-to-spatial-data">Converting to Spatial Data</a>
  <ul class="collapse">
  <li><a href="#step-1-make-your-data-spatial" id="toc-step-1-make-your-data-spatial" class="nav-link" data-scroll-target="#step-1-make-your-data-spatial">Step 1: Make your data spatial</a></li>
  </ul></li>
  <li><a href="#step-2-spatial-join-with-neighborhoods" id="toc-step-2-spatial-join-with-neighborhoods" class="nav-link" data-scroll-target="#step-2-spatial-join-with-neighborhoods">Step 2: Spatial Join with Neighborhoods</a></li>
  <li><a href="#visualize-prices-by-neighborhood" id="toc-visualize-prices-by-neighborhood" class="nav-link" data-scroll-target="#visualize-prices-by-neighborhood">Visualize: Prices by Neighborhood</a></li>
  <li><a href="#the-spatial-pattern-is-clear" id="toc-the-spatial-pattern-is-clear" class="nav-link" data-scroll-target="#the-spatial-pattern-is-clear">The Spatial Pattern is Clear!</a></li>
  </ul></li>
  <li><a href="#part-1-expanding-your-regression-toolkit" id="toc-part-1-expanding-your-regression-toolkit" class="nav-link" data-scroll-target="#part-1-expanding-your-regression-toolkit">Part 1: Expanding Your Regression Toolkit</a>
  <ul class="collapse">
  <li><a href="#beyond-continuous-variables" id="toc-beyond-continuous-variables" class="nav-link" data-scroll-target="#beyond-continuous-variables">Beyond Continuous Variables</a></li>
  <li><a href="#dummy-variables" id="toc-dummy-variables" class="nav-link" data-scroll-target="#dummy-variables">Dummy Variables</a>
  <ul class="collapse">
  <li><a href="#our-boston-data-name-variable-from-spatial-join" id="toc-our-boston-data-name-variable-from-spatial-join" class="nav-link" data-scroll-target="#our-boston-data-name-variable-from-spatial-join">Our Boston Data: <code>name</code> variable from spatial join</a></li>
  </ul></li>
  <li><a href="#add-dummy-categorical-variables-to-the-model" id="toc-add-dummy-categorical-variables-to-the-model" class="nav-link" data-scroll-target="#add-dummy-categorical-variables-to-the-model">Add Dummy (Categorical) Variables to the Model</a></li>
  <li><a href="#interpreting-neighborhood-dummy-variables" id="toc-interpreting-neighborhood-dummy-variables" class="nav-link" data-scroll-target="#interpreting-neighborhood-dummy-variables">Interpreting Neighborhood Dummy Variables</a>
  <ul class="collapse">
  <li><a href="#how-to-read-this-table" id="toc-how-to-read-this-table" class="nav-link" data-scroll-target="#how-to-read-this-table">How to Read This Table</a></li>
  </ul></li>
  <li><a href="#concrete-example-comparing-two-houses" id="toc-concrete-example-comparing-two-houses" class="nav-link" data-scroll-target="#concrete-example-comparing-two-houses">Concrete Example: Comparing Two Houses</a></li>
  <li><a href="#interaction-effects-when-relationships-depend" id="toc-interaction-effects-when-relationships-depend" class="nav-link" data-scroll-target="#interaction-effects-when-relationships-depend">Interaction Effects: When Relationships Depend</a>
  <ul class="collapse">
  <li><a href="#the-question" id="toc-the-question" class="nav-link" data-scroll-target="#the-question">The Question</a></li>
  <li><a href="#example-scenarios" id="toc-example-scenarios" class="nav-link" data-scroll-target="#example-scenarios">Example Scenarios</a></li>
  </ul></li>
  <li><a href="#theory-luxury-premium-hypothesis" id="toc-theory-luxury-premium-hypothesis" class="nav-link" data-scroll-target="#theory-luxury-premium-hypothesis">Theory: Luxury Premium Hypothesis</a></li>
  <li><a href="#create-the-neighborhood-categories" id="toc-create-the-neighborhood-categories" class="nav-link" data-scroll-target="#create-the-neighborhood-categories">Create the Neighborhood Categories</a></li>
  <li><a href="#model-1-no-interaction-parallel-slopes" id="toc-model-1-no-interaction-parallel-slopes" class="nav-link" data-scroll-target="#model-1-no-interaction-parallel-slopes">Model 1: No Interaction (Parallel Slopes)</a></li>
  <li><a href="#model-2-with-interaction-different-slopes" id="toc-model-2-with-interaction-different-slopes" class="nav-link" data-scroll-target="#model-2-with-interaction-different-slopes">Model 2: With Interaction (Different Slopes)</a></li>
  <li><a href="#interpreting-the-interaction-coefficients" id="toc-interpreting-the-interaction-coefficients" class="nav-link" data-scroll-target="#interpreting-the-interaction-coefficients">Interpreting the Interaction Coefficients</a></li>
  <li><a href="#breaking-down-the-coefficients" id="toc-breaking-down-the-coefficients" class="nav-link" data-scroll-target="#breaking-down-the-coefficients">Breaking Down the Coefficients</a></li>
  <li><a href="#visualizing-the-interaction-effect" id="toc-visualizing-the-interaction-effect" class="nav-link" data-scroll-target="#visualizing-the-interaction-effect">Visualizing the Interaction Effect</a></li>
  <li><a href="#compare-model-performance" id="toc-compare-model-performance" class="nav-link" data-scroll-target="#compare-model-performance">Compare Model Performance</a></li>
  <li><a href="#policy-implications" id="toc-policy-implications" class="nav-link" data-scroll-target="#policy-implications">Policy Implications</a></li>
  <li><a href="#when-not-to-use-interactions" id="toc-when-not-to-use-interactions" class="nav-link" data-scroll-target="#when-not-to-use-interactions">When Not To Use Interactions</a></li>
  <li><a href="#polynomial-terms-non-linear-relationships" id="toc-polynomial-terms-non-linear-relationships" class="nav-link" data-scroll-target="#polynomial-terms-non-linear-relationships">Polynomial Terms: Non-Linear Relationships</a>
  <ul class="collapse">
  <li><a href="#when-straight-lines-dont-fit" id="toc-when-straight-lines-dont-fit" class="nav-link" data-scroll-target="#when-straight-lines-dont-fit">When Straight Lines Don’t Fit</a></li>
  </ul></li>
  <li><a href="#theory-the-u-shaped-age-effect" id="toc-theory-the-u-shaped-age-effect" class="nav-link" data-scroll-target="#theory-the-u-shaped-age-effect">Theory: The U-Shaped Age Effect</a>
  <ul class="collapse">
  <li><a href="#why-would-age-have-a-non-linear-effect" id="toc-why-would-age-have-a-non-linear-effect" class="nav-link" data-scroll-target="#why-would-age-have-a-non-linear-effect">Why Would Age Have a Non-Linear Effect?</a></li>
  </ul></li>
  <li><a href="#create-age-variable" id="toc-create-age-variable" class="nav-link" data-scroll-target="#create-age-variable">Create Age Variable</a></li>
  <li><a href="#first-linear-model-baseline" id="toc-first-linear-model-baseline" class="nav-link" data-scroll-target="#first-linear-model-baseline">First: Linear Model (Baseline)</a></li>
  <li><a href="#visualize-is-the-relationship-linear" id="toc-visualize-is-the-relationship-linear" class="nav-link" data-scroll-target="#visualize-is-the-relationship-linear">Visualize: Is the relationship Linear?</a></li>
  <li><a href="#add-polynomial-term-age-squared" id="toc-add-polynomial-term-age-squared" class="nav-link" data-scroll-target="#add-polynomial-term-age-squared">Add Polynomial Term: Age Squared</a></li>
  <li><a href="#interpreting-polynomial-coefficients" id="toc-interpreting-polynomial-coefficients" class="nav-link" data-scroll-target="#interpreting-polynomial-coefficients">Interpreting Polynomial Coefficients</a></li>
  <li><a href="#compare-model-performance-1" id="toc-compare-model-performance-1" class="nav-link" data-scroll-target="#compare-model-performance-1">Compare Model Performance</a></li>
  <li><a href="#check-residual-plot" id="toc-check-residual-plot" class="nav-link" data-scroll-target="#check-residual-plot">Check Residual Plot</a></li>
  </ul></li>
  <li><a href="#part-3-creating-spatial-features" id="toc-part-3-creating-spatial-features" class="nav-link" data-scroll-target="#part-3-creating-spatial-features">Part 3: Creating Spatial Features</a>
  <ul class="collapse">
  <li><a href="#why-space-matters-for-housing-prices" id="toc-why-space-matters-for-housing-prices" class="nav-link" data-scroll-target="#why-space-matters-for-housing-prices">Why Space Matters for Housing Prices</a>
  <ul class="collapse">
  <li><a href="#toblers-first-law-of-geography" id="toc-toblers-first-law-of-geography" class="nav-link" data-scroll-target="#toblers-first-law-of-geography">Tobler’s First Law of Geography</a></li>
  <li><a href="#what-this-means-for-house-prices" id="toc-what-this-means-for-house-prices" class="nav-link" data-scroll-target="#what-this-means-for-house-prices">What This Means for House Prices</a></li>
  </ul></li>
  <li><a href="#three-approaches-to-spatial-features" id="toc-three-approaches-to-spatial-features" class="nav-link" data-scroll-target="#three-approaches-to-spatial-features">Three Approaches to Spatial Features</a>
  <ul class="collapse">
  <li><a href="#buffer-aggregation" id="toc-buffer-aggregation" class="nav-link" data-scroll-target="#buffer-aggregation">1️⃣ Buffer Aggregation</a></li>
  <li><a href="#k-nearest-neighbors-knn" id="toc-k-nearest-neighbors-knn" class="nav-link" data-scroll-target="#k-nearest-neighbors-knn">2️⃣ k-Nearest Neighbors (kNN)</a></li>
  <li><a href="#distance-to-specific-points" id="toc-distance-to-specific-points" class="nav-link" data-scroll-target="#distance-to-specific-points">3️⃣ Distance to Specific Points</a></li>
  </ul></li>
  <li><a href="#load-and-prepare-crime-data" id="toc-load-and-prepare-crime-data" class="nav-link" data-scroll-target="#load-and-prepare-crime-data">Load and Prepare Crime Data</a></li>
  <li><a href="#visaulize-crime-locations" id="toc-visaulize-crime-locations" class="nav-link" data-scroll-target="#visaulize-crime-locations">Visaulize: Crime Locations</a></li>
  <li><a href="#approach-1-buffer-aggregation" id="toc-approach-1-buffer-aggregation" class="nav-link" data-scroll-target="#approach-1-buffer-aggregation">Approach 1: Buffer Aggregation</a></li>
  <li><a href="#approach-2-k-nearest-neighborhoods-method" id="toc-approach-2-k-nearest-neighborhoods-method" class="nav-link" data-scroll-target="#approach-2-k-nearest-neighborhoods-method">Approach 2: k-Nearest Neighborhoods Method</a></li>
  <li><a href="#which-k-value-correlates-most-with-price" id="toc-which-k-value-correlates-most-with-price" class="nav-link" data-scroll-target="#which-k-value-correlates-most-with-price">Which k value correlates most with price?</a>
  <ul class="collapse">
  <li><a href="#all-spatial-features-together" id="toc-all-spatial-features-together" class="nav-link" data-scroll-target="#all-spatial-features-together">All spatial features together</a></li>
  <li><a href="#model-comparison-adding-spatial-features" id="toc-model-comparison-adding-spatial-features" class="nav-link" data-scroll-target="#model-comparison-adding-spatial-features">Model Comparison: Adding Spatial Features</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#part-3-fixed-effects" id="toc-part-3-fixed-effects" class="nav-link" data-scroll-target="#part-3-fixed-effects">Part 3: Fixed Effects</a>
  <ul class="collapse">
  <li><a href="#what-are-fixed-effects" id="toc-what-are-fixed-effects" class="nav-link" data-scroll-target="#what-are-fixed-effects">What Are Fixed Effects?</a></li>
  <li><a href="#how-fixed-effects-work" id="toc-how-fixed-effects-work" class="nav-link" data-scroll-target="#how-fixed-effects-work">How Fixed Effects Work</a></li>
  <li><a href="#why-use-fixed-effects" id="toc-why-use-fixed-effects" class="nav-link" data-scroll-target="#why-use-fixed-effects">Why Use Fixed Effects?</a></li>
  <li><a href="#lets-compare-all-our-models" id="toc-lets-compare-all-our-models" class="nav-link" data-scroll-target="#lets-compare-all-our-models">Let’s Compare All Our Models</a></li>
  </ul></li>
  <li><a href="#part-5-cross-validation-with-categorical-variables" id="toc-part-5-cross-validation-with-categorical-variables" class="nav-link" data-scroll-target="#part-5-cross-validation-with-categorical-variables">Part 5: Cross-Validation (with Categorical Variables)</a>
  <ul class="collapse">
  <li><a href="#cv-recap-from-last-week" id="toc-cv-recap-from-last-week" class="nav-link" data-scroll-target="#cv-recap-from-last-week">CV Recap (From Last Week)</a></li>
  <li><a href="#comparing-models-with-cv" id="toc-comparing-models-with-cv" class="nav-link" data-scroll-target="#comparing-models-with-cv">Comparing Models with CV</a></li>
  <li><a href="#the-problem-sparse-categories" id="toc-the-problem-sparse-categories" class="nav-link" data-scroll-target="#the-problem-sparse-categories">⚠️ The Problem: Sparse Categories</a>
  <ul class="collapse">
  <li><a href="#when-cv-fails-with-categorical-variables" id="toc-when-cv-fails-with-categorical-variables" class="nav-link" data-scroll-target="#when-cv-fails-with-categorical-variables">When CV Fails with Categorical Variables</a></li>
  </ul></li>
  <li><a href="#check-your-data-first" id="toc-check-your-data-first" class="nav-link" data-scroll-target="#check-your-data-first">Check Your Data First!</a></li>
  <li><a href="#solution-group-small-neighborhoods" id="toc-solution-group-small-neighborhoods" class="nav-link" data-scroll-target="#solution-group-small-neighborhoods">Solution: Group Small Neighborhoods</a></li>
  <li><a href="#alternative-drop-sparse-categories" id="toc-alternative-drop-sparse-categories" class="nav-link" data-scroll-target="#alternative-drop-sparse-categories">Alternative: Drop Sparse Categories</a></li>
  <li><a href="#my-recommended-workflow" id="toc-my-recommended-workflow" class="nav-link" data-scroll-target="#my-recommended-workflow">My Recommended Workflow</a></li>
  <li><a href="#full-model-comparison-with-cv" id="toc-full-model-comparison-with-cv" class="nav-link" data-scroll-target="#full-model-comparison-with-cv">Full Model Comparison with CV</a></li>
  <li><a href="#expected-results" id="toc-expected-results" class="nav-link" data-scroll-target="#expected-results">Expected Results</a></li>
  <li><a href="#investigating-those-errors" id="toc-investigating-those-errors" class="nav-link" data-scroll-target="#investigating-those-errors">Investigating those errors…</a></li>
  </ul></li>
  <li><a href="#what-to-do" id="toc-what-to-do" class="nav-link" data-scroll-target="#what-to-do">What to Do?</a>
  <ul class="collapse">
  <li><a href="#team-exercise-practice-what-weve-done-and-build-your-best-model" id="toc-team-exercise-practice-what-weve-done-and-build-your-best-model" class="nav-link" data-scroll-target="#team-exercise-practice-what-weve-done-and-build-your-best-model">Team Exercise: Practice What We’ve Done and Build Your Best Model</a></li>
  <li><a href="#use-diagnostics-from-last-week-as-you-build" id="toc-use-diagnostics-from-last-week-as-you-build" class="nav-link" data-scroll-target="#use-diagnostics-from-last-week-as-you-build"><em>Use diagnostics from last week as you build!</em></a></li>
  <li><a href="#report-out-on-board" id="toc-report-out-on-board" class="nav-link" data-scroll-target="#report-out-on-board">Report Out on Board</a></li>
  <li><a href="#tips-for-success" id="toc-tips-for-success" class="nav-link" data-scroll-target="#tips-for-success">Tips for Success</a></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="week-06-class-lab.html"><i class="bi bi-file-slides"></i>RevealJS</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Spatial Machine Learning &amp; Advanced Regression</h1>
<p class="subtitle lead">Week 6: MUSA 5080</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Dr.&nbsp;Elizabeth Delmelle </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 14, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="todays-journey" class="level1">
<h1>Today’s Journey</h1>
<section id="what-well-cover" class="level2">
<h2 class="anchored" data-anchor-id="what-well-cover">What We’ll Cover</h2>
<div class="columns">
<div class="column" style="width:50%;">
<p><strong>Warm-Up: Build a Baseline Model</strong></p>
<ul>
<li>Quick review of Week 5 regression</li>
<li>Create simple structural model</li>
<li>Identify its limitations</li>
</ul>
<p><strong>Part 1: Expanding Your Toolkit</strong></p>
<ul>
<li>Categorical variables</li>
<li>Interactions</li>
<li>Polynomial terms</li>
</ul>
</div><div class="column" style="width:50%;">
<p><strong>Part 2: Why Space Matters</strong></p>
<ul>
<li>Hedonic model framework</li>
<li>Tobler’s First Law</li>
<li>Spatial autocorrelation</li>
</ul>
<p><strong>Part 3: Creating Spatial Features</strong></p>
<ul>
<li>Buffer aggregation</li>
<li>k-Nearest Neighbors</li>
<li>Distance to amenities</li>
</ul>
</div>
</div>
<p><strong>Part 4: Fixed Effects</strong></p>
<hr>
</section>
</section>
<section id="warm-up-build-a-baseline-model" class="level1">
<h1>Warm-Up: Build a Baseline Model</h1>
<section id="lets-build-something-simple-together" class="level2">
<h2 class="anchored" data-anchor-id="lets-build-something-simple-together">Let’s Build Something Simple Together</h2>
<p>We’ll start by creating a basic model using <strong>only structural features</strong> - this will be our baseline to improve upon today.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load packages and data</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.5
✔ forcats   1.0.0     ✔ stringr   1.5.1
✔ ggplot2   3.5.2     ✔ tibble    3.3.0
✔ lubridate 1.9.4     ✔ tidyr     1.3.1
✔ purrr     1.1.0     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Linking to GEOS 3.13.1, GDAL 3.11.0, PROJ 9.6.0; sf_use_s2() is TRUE</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>here() starts at C:/Users/Tess/Documents/GitHub/portfolio-setup-TessaVu/weekly-notes/week-06</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load Boston housing data</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>boston <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">here</span>(<span class="st">"data/boston.csv"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>New names:
Rows: 1485 Columns: 24
── Column specification
──────────────────────────────────────────────────────── Delimiter: "," chr
(8): Style, R_AC, LU, OWN_OCC, R_BLDG_STY, R_ROOF_TYP, R_EXT_FIN, R_HEA... dbl
(16): ...1, Parcel_No, SalePrice, PricePerSq, LivingArea, GROSS_AREA, NU...
ℹ Use `spec()` to retrieve the full column specification for this data. ℹ
Specify the column types or set `show_col_types = FALSE` to quiet this message.
• `` -&gt; `...1`</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Quick look at the data</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(boston)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 1,485
Columns: 24
$ ...1       &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, …
$ Parcel_No  &lt;dbl&gt; 100032000, 100058000, 100073000, 100112000, 100137000, 1001…
$ SalePrice  &lt;dbl&gt; 450000, 600000, 450000, 670000, 260000, 355000, 665000, 355…
$ PricePerSq &lt;dbl&gt; 228.89, 164.34, 105.98, 291.94, 217.21, 190.96, 227.35, 120…
$ LivingArea &lt;dbl&gt; 1966, 3840, 4246, 2295, 1197, 1859, 2925, 2904, 892, 1916, …
$ Style      &lt;chr&gt; "Conventional", "Semi?Det", "Decker", "Row\xa0End", "Coloni…
$ GROSS_AREA &lt;dbl&gt; 3111, 5603, 6010, 3482, 1785, 2198, 4341, 3892, 1658, 3318,…
$ NUM_FLOORS &lt;dbl&gt; 2.0, 3.0, 3.0, 3.0, 2.0, 1.5, 3.0, 3.0, 2.0, 2.0, 1.5, 2.0,…
$ R_BDRMS    &lt;dbl&gt; 4, 8, 9, 6, 2, 3, 8, 6, 2, 2, 4, 3, 3, 3, 6, 8, 4, 4, 3, 2,…
$ R_FULL_BTH &lt;dbl&gt; 2, 3, 3, 3, 1, 3, 3, 3, 1, 2, 2, 3, 1, 1, 3, 3, 2, 3, 1, 2,…
$ R_HALF_BTH &lt;dbl&gt; 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0,…
$ R_KITCH    &lt;dbl&gt; 2, 3, 3, 3, 1, 2, 3, 3, 1, 2, 2, 3, 1, 1, 3, 3, 2, 3, 2, 2,…
$ R_AC       &lt;chr&gt; "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "N",…
$ R_FPLACE   &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ LU         &lt;chr&gt; "R2", "R3", "R3", "R3", "R1", "R2", "R3", "E", "R1", "R2", …
$ OWN_OCC    &lt;chr&gt; "Y", "N", "Y", "N", "N", "N", "N", "N", "N", "Y", "N", "N",…
$ R_BLDG_STY &lt;chr&gt; "CV", "SD", "DK", "RE", "CL", "CV", "DK", "DK", "RE", "TF",…
$ R_ROOF_TYP &lt;chr&gt; "H", "F", "F", "F", "F", "G", "F", "F", "G", "F", "G", "F",…
$ R_EXT_FIN  &lt;chr&gt; "M", "B", "M", "M", "P", "M", "M", "A", "A", "M", "W", "W",…
$ R_TOTAL_RM &lt;dbl&gt; 10, 17, 20, 14, 5, 8, 14, 14, 4, 9, 7, 7, 5, 5, 15, 14, 11,…
$ R_HEAT_TYP &lt;chr&gt; "W", "W", "W", "W", "E", "E", "W", "W", "W", "W", "W", "W",…
$ YR_BUILT   &lt;dbl&gt; 1900, 1910, 1910, 1905, 1860, 1905, 1900, 1890, 1900, 1900,…
$ Latitude   &lt;dbl&gt; 42.37963, 42.37877, 42.37940, 42.38014, 42.37967, 42.37953,…
$ Longitude  &lt;dbl&gt; -71.03076, -71.02943, -71.02846, -71.02859, -71.02903, -71.…</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple model: Predict price from living area</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>baseline_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(SalePrice <span class="sc">~</span> LivingArea, <span class="at">data =</span> boston)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(baseline_model)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = SalePrice ~ LivingArea, data = boston)

Residuals:
    Min      1Q  Median      3Q     Max 
-855962 -219491  -68291   55248 9296561 

Coefficients:
             Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 157968.32   35855.59   4.406 1.13e-05 ***
LivingArea     216.54      14.47  14.969  &lt; 2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 563800 on 1483 degrees of freedom
Multiple R-squared:  0.1313,    Adjusted R-squared:  0.1307 
F-statistic: 224.1 on 1 and 1483 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<hr>
</section>
<section id="what-does-this-model-tell-us" class="level2">
<h2 class="anchored" data-anchor-id="what-does-this-model-tell-us">What Does This Model Tell Us?</h2>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = SalePrice ~ LivingArea, data = boston)

Residuals:
    Min      1Q  Median      3Q     Max 
-855962 -219491  -68291   55248 9296561 

Coefficients:
             Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 157968.32   35855.59   4.406 1.13e-05 ***
LivingArea     216.54      14.47  14.969  &lt; 2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 563800 on 1483 degrees of freedom
Multiple R-squared:  0.1313,    Adjusted R-squared:  0.1307 
F-statistic: 224.1 on 1 and 1483 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1312636</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week-06-class-lab_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
<section id="interpreting-our-baseline" class="level2">
<h2 class="anchored" data-anchor-id="interpreting-our-baseline">Interpreting Our Baseline</h2>
<p><strong>Expected Output:</strong></p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Variable</th>
<th>Coefficient</th>
<th>Std. Error</th>
<th>t-value</th>
<th>p-value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Intercept</td>
<td>157968.32</td>
<td>35855.59</td>
<td>4.406</td>
<td>&lt;0.001</td>
</tr>
<tr class="even">
<td>LivingArea</td>
<td>216.54</td>
<td>14.47</td>
<td>14.969</td>
<td>&lt;0.001</td>
</tr>
</tbody>
</table>
<p><strong>What this means:</strong></p>
<ul>
<li>Base price (0 sq ft) ≈ 157968.32</li>
<li>Each additional square foot adds ~216 to price</li>
<li>Relationship is statistically significant (p &lt; 0.001)</li>
<li>But R² is only <strong>0.13</strong> (13% of variation explained)</li>
</ul>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>The Problem
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>MOST of the variation in house prices is still unexplained!</strong></p>
<p>What are we missing? 🤔</p>
</div>
</div>
<hr>
</section>
<section id="limitations-of-this-model" class="level2">
<h2 class="anchored" data-anchor-id="limitations-of-this-model">Limitations of This Model</h2>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>What’s Missing?
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li><strong>What does this model ignore?</strong>
<ul>
<li>Location! (North End vs.&nbsp;Roxbury vs.&nbsp;Back Bay)</li>
<li>Proximity to downtown, waterfront, parks</li>
<li>Nearby crime levels</li>
<li>School quality</li>
<li>Neighborhood characteristics</li>
</ul></li>
<li><strong>Why might it fail?</strong>
<ul>
<li>1,000 sq ft in Back Bay ≠ 1,000 sq ft in Roxbury</li>
<li>Same house, different locations → vastly different prices</li>
<li>“Location, location, location!”</li>
</ul></li>
<li><strong>How could we improve it?</strong>
<ul>
<li>Add spatial features (crime nearby, distance to amenities)</li>
<li>Control for neighborhood (fixed effects)</li>
<li>Include interactions (does size matter more in wealthy areas?)</li>
</ul></li>
</ol>
</div>
</div>
<p><strong>This is exactly where spatial features come in!</strong></p>
<hr>
</section>
<section id="lets-add-one-more-feature" class="level2">
<h2 class="anchored" data-anchor-id="lets-add-one-more-feature">Let’s Add One More Feature</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add number of bathrooms</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>better_model <span class="ot">&lt;-</span> <span class="fu">lm</span>(SalePrice <span class="sc">~</span> LivingArea <span class="sc">+</span> R_FULL_BTH, <span class="at">data =</span> boston)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(better_model)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = SalePrice ~ LivingArea + R_FULL_BTH, data = boston)

Residuals:
    Min      1Q  Median      3Q     Max 
-783019 -230756  -65737   75367 9193133 

Coefficients:
             Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 107683.96   37340.88   2.884  0.00399 ** 
LivingArea     145.68      21.33   6.828 1.25e-11 ***
R_FULL_BTH  106978.13   23800.30   4.495 7.50e-06 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 560200 on 1482 degrees of freedom
Multiple R-squared:  0.1429,    Adjusted R-squared:  0.1418 
F-statistic: 123.6 on 2 and 1482 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare models</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Baseline R²:"</span>, <span class="fu">summary</span>(baseline_model)<span class="sc">$</span>r.squared, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Baseline R²: 0.1312636 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"With bathrooms R²:"</span>, <span class="fu">summary</span>(better_model)<span class="sc">$</span>r.squared, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>With bathrooms R²: 0.1429474 </code></pre>
</div>
</div>
<p><strong>R² improves a smidge… but still missing location!</strong></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Today’s Goal
</div>
</div>
<div class="callout-body-container callout-body">
<p>By the end of class, you’ll build models that: - Incorporate spatial relationships - Account for neighborhood effects<br>
- Achieve much better prediction accuracy - Help you understand what drives housing prices</p>
</div>
</div>
<hr>
</section>
<section id="converting-to-spatial-data" class="level2">
<h2 class="anchored" data-anchor-id="converting-to-spatial-data">Converting to Spatial Data</h2>
<section id="step-1-make-your-data-spatial" class="level3">
<h3 class="anchored" data-anchor-id="step-1-make-your-data-spatial">Step 1: Make your data spatial</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert boston data to sf object</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>boston.sf <span class="ot">&lt;-</span> boston <span class="sc">%&gt;%</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"Longitude"</span>, <span class="st">"Latitude"</span>), <span class="at">crs =</span> <span class="dv">4326</span>) <span class="sc">%&gt;%</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="st">'ESRI:102286'</span>)  <span class="co"># MA State Plane (feet)</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Check it worked</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(boston.sf)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 6 features and 22 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 238643.6 ymin: 903246 xmax: 238833.2 ymax: 903399.5
Projected CRS: NAD_1983_HARN_StatePlane_Massachusetts_Mainland_FIPS_2001
# A tibble: 6 × 23
   ...1 Parcel_No SalePrice PricePerSq LivingArea Style    GROSS_AREA NUM_FLOORS
  &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt; &lt;chr&gt;         &lt;dbl&gt;      &lt;dbl&gt;
1     1 100032000    450000       229.       1966 "Conven…       3111        2  
2     2 100058000    600000       164.       3840 "Semi?D…       5603        3  
3     3 100073000    450000       106.       4246 "Decker"       6010        3  
4     4 100112000    670000       292.       2295 "Row\xa…       3482        3  
5     5 100137000    260000       217.       1197 "Coloni…       1785        2  
6     6 100138000    355000       191.       1859 "Conven…       2198        1.5
# ℹ 15 more variables: R_BDRMS &lt;dbl&gt;, R_FULL_BTH &lt;dbl&gt;, R_HALF_BTH &lt;dbl&gt;,
#   R_KITCH &lt;dbl&gt;, R_AC &lt;chr&gt;, R_FPLACE &lt;dbl&gt;, LU &lt;chr&gt;, OWN_OCC &lt;chr&gt;,
#   R_BLDG_STY &lt;chr&gt;, R_ROOF_TYP &lt;chr&gt;, R_EXT_FIN &lt;chr&gt;, R_TOTAL_RM &lt;dbl&gt;,
#   R_HEAT_TYP &lt;chr&gt;, YR_BUILT &lt;dbl&gt;, geometry &lt;POINT [m]&gt;</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(boston.sf)  <span class="co"># Should show "sf" and "data.frame"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "sf"         "tbl_df"     "tbl"        "data.frame"</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Why transform CRS?
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><strong>4326</strong> = WGS84 (lat/lon in degrees) - fine for display</li>
<li><strong>ESRI:102286</strong> = MA State Plane (feet) - good for distance calculations</li>
</ul>
</div>
</div>
<hr>
</section>
</section>
<section id="step-2-spatial-join-with-neighborhoods" class="level2">
<h2 class="anchored" data-anchor-id="step-2-spatial-join-with-neighborhoods">Step 2: Spatial Join with Neighborhoods</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load neighborhood boundaries</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>nhoods <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="fu">here</span>(<span class="st">"data/BPDA_Neighborhood_Boundaries.geojson"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="st">'ESRI:102286'</span>)  <span class="co"># Match CRS!</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the neighborhoods</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(nhoods)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 6 features and 7 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 229049.1 ymin: 890856 xmax: 236590.9 ymax: 900302.5
Projected CRS: NAD_1983_HARN_StatePlane_Massachusetts_Mainland_FIPS_2001
# A tibble: 6 × 8
  sqmiles name         neighborhood_id  acres SHAPE__Length objectid SHAPE__Area
    &lt;dbl&gt; &lt;chr&gt;        &lt;chr&gt;            &lt;dbl&gt;         &lt;dbl&gt;    &lt;int&gt;       &lt;dbl&gt;
1    2.51 Roslindale   15              1606.         53564.       53   69938273.
2    3.94 Jamaica Pla… 11              2519.         56350.       54  109737890.
3    0.55 Mission Hill 13               351.         17919.       55   15283120.
4    0.29 Longwood     28               189.         11909.       56    8215904.
5    0.04 Bay Village  33                26.5         4651.       57    1156071.
6    0.02 Leather Dis… 27                15.6         3237.       58     681272.
# ℹ 1 more variable: geometry &lt;MULTIPOLYGON [m]&gt;</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(nhoods)  <span class="co"># How many neighborhoods?</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 26</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Spatial join: Assign each house to its neighborhood</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>boston.sf <span class="ot">&lt;-</span> boston.sf <span class="sc">%&gt;%</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_join</span>(nhoods, <span class="at">join =</span> st_intersects)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Check results</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>boston.sf <span class="sc">%&gt;%</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(name) <span class="sc">%&gt;%</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 19 × 2
   name              n
   &lt;chr&gt;         &lt;int&gt;
 1 Dorchester      344
 2 West Roxbury    242
 3 Hyde Park       152
 4 East Boston     149
 5 Roslindale      142
 6 Jamaica Plain   113
 7 South Boston     80
 8 Charlestown      65
 9 Mattapan         65
10 Roxbury          63
11 South End        20
12 Beacon Hill      17
13 Mission Hill     14
14 Allston           6
15 Brighton          6
16 Back Bay          3
17 Fenway            2
18 Bay Village       1
19 Downtown          1</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>What just happened?
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>st_join()</code> found which neighborhood polygon contains each house point!</p>
</div>
</div>
<hr>
</section>
<section id="visualize-prices-by-neighborhood" class="level2">
<h2 class="anchored" data-anchor-id="visualize-prices-by-neighborhood">Visualize: Prices by Neighborhood</h2>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week-06-class-lab_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
<section id="the-spatial-pattern-is-clear" class="level2">
<h2 class="anchored" data-anchor-id="the-spatial-pattern-is-clear">The Spatial Pattern is Clear!</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Which neighborhoods are most expensive?</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>price_by_nhood <span class="sc">%&gt;%</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(median_price)) <span class="sc">%&gt;%</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 3
  name        median_price n_sales
  &lt;chr&gt;              &lt;dbl&gt;   &lt;int&gt;
1 Back Bay         9500000       3
2 Beacon Hill      2892750      17
3 South End        2797500      20
4 Bay Village      2300000       1
5 Fenway           2112500       2</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Which have most sales?</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>price_by_nhood <span class="sc">%&gt;%</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n_sales)) <span class="sc">%&gt;%</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 3
  name         median_price n_sales
  &lt;chr&gt;               &lt;dbl&gt;   &lt;int&gt;
1 Dorchester         511250     344
2 West Roxbury       503750     242
3 Hyde Park          390000     152
4 East Boston        463000     149
5 Roslindale         489500     142</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Discussion Question
</div>
</div>
<div class="callout-body-container callout-body">
<p>Why do you think certain neighborhoods command higher prices? - Proximity to downtown? - Historical character? - School quality? - Safety? - All of the above?</p>
<p><strong>This is why we need spatial features and neighborhood controls!</strong></p>
</div>
</div>
<hr>
</section>
</section>
<section id="part-1-expanding-your-regression-toolkit" class="level1" data-background-color="#667eea">
<h1 data-background-color="#667eea">Part 1: Expanding Your Regression Toolkit</h1>
<hr>
<section id="beyond-continuous-variables" class="level2">
<h2 class="anchored" data-anchor-id="beyond-continuous-variables">Beyond Continuous Variables</h2>
<div class="columns">
<div class="column" style="width:50%;">
<section id="continuous-variables" class="level3">
<h3 class="anchored" data-anchor-id="continuous-variables">✅ Continuous Variables</h3>
<ul>
<li>Square footage</li>
<li>Age of house</li>
<li>Income levels</li>
<li>Distance to downtown</li>
</ul>
</section>
</div><div class="column" style="width:50%;">
<section id="categorical-variables" class="level3">
<h3 class="anchored" data-anchor-id="categorical-variables">🏷️ Categorical Variables</h3>
<ul>
<li>Neighborhood</li>
<li>School district</li>
<li>Building type</li>
<li>Has garage? (Yes/No)</li>
</ul>
</section>
</div>
</div>
<hr>
</section>
<section id="dummy-variables" class="level2">
<h2 class="anchored" data-anchor-id="dummy-variables">Dummy Variables</h2>
<section id="our-boston-data-name-variable-from-spatial-join" class="level3">
<h3 class="anchored" data-anchor-id="our-boston-data-name-variable-from-spatial-join">Our Boston Data: <code>name</code> variable from spatial join</h3>
<p>Neighborhoods in our dataset (showing just a few):</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 2
   name              n
   &lt;chr&gt;         &lt;int&gt;
 1 Dorchester      344
 2 West Roxbury    242
 3 Hyde Park       152
 4 East Boston     149
 5 Roslindale      142
 6 Jamaica Plain   113
 7 South Boston     80
 8 Charlestown      65
 9 Mattapan         65
10 Roxbury          63</code></pre>
</div>
</div>
<p><strong>How R Handles This</strong></p>
<p>When you include <code>name</code> in a model, R automatically creates binary indicators:</p>
<ul>
<li><strong>Back_Bay:</strong> 1 if Back Bay, 0 otherwise</li>
<li><strong>Beacon_Hill:</strong> 1 if Beacon Hill, 0 otherwise</li>
<li><strong>Charlestown:</strong> 1 if Charlestown, 0 otherwise</li>
<li>…and so on for all neighborhoods</li>
</ul>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>⚠️ The (n-1) Rule
</div>
</div>
<div class="callout-body-container callout-body">
<p>One neighborhood is automatically chosen as the <strong>reference category</strong> (omitted)!</p>
<p>R picks the first alphabetically unless you specify otherwise.</p>
</div>
</div>
<hr>
</section>
</section>
<section id="add-dummy-categorical-variables-to-the-model" class="level2">
<h2 class="anchored" data-anchor-id="add-dummy-categorical-variables-to-the-model">Add Dummy (Categorical) Variables to the Model</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure name is a factor</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>boston.sf <span class="ot">&lt;-</span> boston.sf <span class="sc">%&gt;%</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="fu">as.factor</span>(name))</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Check which is reference (first alphabetically)</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="fu">levels</span>(boston.sf<span class="sc">$</span>name)[<span class="dv">1</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Allston"</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit model with neighborhood fixed effects</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>model_neighborhoods <span class="ot">&lt;-</span> <span class="fu">lm</span>(SalePrice <span class="sc">~</span> LivingArea <span class="sc">+</span> name, </span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">data =</span> boston.sf)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Show just first 10 coefficients</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_neighborhoods)<span class="sc">$</span>coef[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, ]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                    Estimate   Std. Error    t value      Pr(&gt;|t|)
(Intercept)      704306.0751 9.022210e+04  7.8063584  1.112892e-14
LivingArea          138.3206 6.468186e+00 21.3847638  1.605175e-88
nameBack Bay    7525585.0560 1.533714e+05 49.0677253 1.522921e-311
nameBay Village 1284057.5326 2.320256e+05  5.5341206  3.700442e-08
nameBeacon Hill 1767805.2297 1.020211e+05 17.3278366  2.465874e-61
nameBrighton    -168941.2113 1.239972e+05 -1.3624597  1.732623e-01
nameCharlestown   -2556.8667 9.208989e+04 -0.0277649  9.778534e-01
nameDorchester  -576819.4858 8.846990e+04 -6.5199517  9.653393e-11
nameDowntown      58553.1237 2.322150e+05  0.2521505  8.009601e-01
nameEast Boston -534060.4110 8.962950e+04 -5.9585340  3.182615e-09</code></pre>
</div>
</div>
<hr>
</section>
<section id="interpreting-neighborhood-dummy-variables" class="level2">
<h2 class="anchored" data-anchor-id="interpreting-neighborhood-dummy-variables">Interpreting Neighborhood Dummy Variables</h2>
<div class="cell">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Variable</th>
<th style="text-align: right;">Coefficient</th>
<th style="text-align: right;">p-value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Intercept (Allston)</td>
<td style="text-align: right;">$649,635</td>
<td style="text-align: right;">&lt; 0.001***</td>
</tr>
<tr class="even">
<td style="text-align: left;">Living Area (per sq ft)</td>
<td style="text-align: right;">$114</td>
<td style="text-align: right;">&lt; 0.001***</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Back Bay</td>
<td style="text-align: right;">$7,561,273</td>
<td style="text-align: right;">&lt; 0.001***</td>
</tr>
<tr class="even">
<td style="text-align: left;">Beacon Hill</td>
<td style="text-align: right;">$1,780,861</td>
<td style="text-align: right;">&lt; 0.001***</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Charlestown</td>
<td style="text-align: right;">$22,575</td>
<td style="text-align: right;">0.806</td>
</tr>
<tr class="even">
<td style="text-align: left;">Dorchester</td>
<td style="text-align: right;">-$540,267</td>
<td style="text-align: right;">&lt; 0.001***</td>
</tr>
<tr class="odd">
<td style="text-align: left;">East Boston</td>
<td style="text-align: right;">-$515,990</td>
<td style="text-align: right;">&lt; 0.001***</td>
</tr>
<tr class="even">
<td style="text-align: left;">Roxbury</td>
<td style="text-align: right;">-$566,534</td>
<td style="text-align: right;">&lt; 0.001***</td>
</tr>
</tbody>
</table>
</div>
</div>
<section id="how-to-read-this-table" class="level3">
<h3 class="anchored" data-anchor-id="how-to-read-this-table">How to Read This Table</h3>
<p><strong>Reference Category:</strong> Allston (automatically chosen - alphabetically first)</p>
<p><strong>Structural Variables:</strong></p>
<ul>
<li><strong>Living Area:</strong> Each additional sq ft adds this amount (same for all neighborhoods)</li>
<li><strong>Bedrooms:</strong> Effect of one more full bathroom (same for all neighborhoods)</li>
</ul>
<p><strong>Neighborhood Dummies:</strong></p>
<ul>
<li><strong>Positive coefficient</strong> = This neighborhood is MORE expensive than Allston</li>
<li><strong>Negative coefficient</strong> = This neighborhood is LESS expensive than Allston</li>
<li>All else equal (same size, same bathrooms)</li>
</ul>
<hr>
</section>
</section>
<section id="concrete-example-comparing-two-houses" class="level2">
<h2 class="anchored" data-anchor-id="concrete-example-comparing-two-houses">Concrete Example: Comparing Two Houses</h2>
<p>Using our model, let’s compare identical houses in different neighborhoods:</p>
<div class="columns">
<div class="column" style="width:50%;">
<section id="house-a-back-bay" class="level3">
<h3 class="anchored" data-anchor-id="house-a-back-bay">House A: Back Bay</h3>
<ul>
<li>Living Area: 1,500 sq ft</li>
<li>Baths: 2</li>
<li><strong>Neighborhood:</strong> Back Bay</li>
</ul>
<p><strong>Predicted Price:</strong></p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>           1 
"$8,458,873" </code></pre>
</div>
</div>
</section>
</div><div class="column" style="width:50%;">
<section id="house-b-roxbury" class="level3">
<h3 class="anchored" data-anchor-id="house-b-roxbury">House B: Roxbury</h3>
<ul>
<li>Living Area: 1,500 sq ft</li>
<li>Baths: 2</li>
<li><strong>Neighborhood:</strong> Roxbury</li>
</ul>
<p><strong>Predicted Price:</strong></p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>         1 
"$331,066" </code></pre>
</div>
</div>
</section>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>The Neighborhood Effect Price Difference</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>           1 
"$8,127,807" </code></pre>
</div>
</div>
<p>Same house, different location = huge price difference! This is what the neighborhood dummies capture.</p>
</div>
</div>
<hr>
</section>
<section id="interaction-effects-when-relationships-depend" class="level2">
<h2 class="anchored" data-anchor-id="interaction-effects-when-relationships-depend">Interaction Effects: When Relationships Depend</h2>
<section id="the-question" class="level3">
<h3 class="anchored" data-anchor-id="the-question">The Question</h3>
<p>Does the effect of one variable <strong>depend on</strong> the level of another variable?</p>
</section>
<section id="example-scenarios" class="level3">
<h3 class="anchored" data-anchor-id="example-scenarios">Example Scenarios</h3>
<ul>
<li><strong>Housing:</strong> Does square footage matter more in wealthy neighborhoods?</li>
<li><strong>Education:</strong> Do tutoring effects vary by initial skill level?</li>
<li><strong>Public Health:</strong> Do pollution effects differ by age?</li>
</ul>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>Mathematical Form
</div>
</div>
<div class="callout-body-container callout-body">
<p>SalePrice = β₀ + β₁(LivingArea) + β₂(WealthyNeighborhood) + <strong>β₃(LivingArea × WealthyNeighborhood)</strong> + ε</p>
</div>
</div>
<p><strong>Today’s example:</strong> Is the value of square footage the same across all Boston neighborhoods?</p>
<hr>
</section>
</section>
<section id="theory-luxury-premium-hypothesis" class="level2">
<h2 class="anchored" data-anchor-id="theory-luxury-premium-hypothesis">Theory: Luxury Premium Hypothesis</h2>
<div class="columns">
<div class="column" style="width:50%;">
<section id="in-wealthy-neighborhoods" class="level3">
<h3 class="anchored" data-anchor-id="in-wealthy-neighborhoods">🏛️ In Wealthy Neighborhoods</h3>
<p>(Back Bay, Beacon Hill, South End)</p>
<ul>
<li>High-end buyers pay premium for space</li>
<li>Luxury finishes, location prestige</li>
<li>Each sq ft adds substantial value</li>
<li><strong>Steep slope</strong></li>
</ul>
<p><strong>Hypothesis:</strong> $300+ per sq ft</p>
</section>
</div><div class="column" style="width:50%;">
<section id="in-working-class-neighborhoods" class="level3">
<h3 class="anchored" data-anchor-id="in-working-class-neighborhoods">🏘️ In Working-Class Neighborhoods</h3>
<p>(Dorchester, Mattapan, East Boston)</p>
<ul>
<li>Buyers value function over luxury</li>
<li>More price-sensitive market</li>
<li>Space matters, but less premium</li>
<li><strong>Flatter slope</strong></li>
</ul>
<p><strong>Hypothesis:</strong> $100-150 per sq ft</p>
</section>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>The Key Question
</div>
</div>
<div class="callout-body-container callout-body">
<p>If we assume one slope for all neighborhoods, are we misunderstanding the market?</p>
</div>
</div>
<hr>
</section>
<section id="create-the-neighborhood-categories" class="level2">
<h2 class="anchored" data-anchor-id="create-the-neighborhood-categories">Create the Neighborhood Categories</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define wealthy neighborhoods based on median prices</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>wealthy_hoods <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Back Bay"</span>, <span class="st">"Beacon Hill"</span>, <span class="st">"South End"</span>, <span class="st">"Bay Village"</span>)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create binary indicator</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>boston.sf <span class="ot">&lt;-</span> boston.sf <span class="sc">%&gt;%</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">wealthy_neighborhood =</span> <span class="fu">ifelse</span>(name <span class="sc">%in%</span> wealthy_hoods, <span class="st">"Wealthy"</span>, <span class="st">"Not Wealthy"</span>),</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">wealthy_neighborhood =</span> <span class="fu">as.factor</span>(wealthy_neighborhood)</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the split</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>boston.sf <span class="sc">%&gt;%</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(wealthy_neighborhood)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  wealthy_neighborhood     n
  &lt;fct&gt;                &lt;int&gt;
1 Not Wealthy           1444
2 Wealthy                 41</code></pre>
</div>
</div>
<hr>
</section>
<section id="model-1-no-interaction-parallel-slopes" class="level2">
<h2 class="anchored" data-anchor-id="model-1-no-interaction-parallel-slopes">Model 1: No Interaction (Parallel Slopes)</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Model assumes same slope everywhere</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>model_no_interact <span class="ot">&lt;-</span> <span class="fu">lm</span>(SalePrice <span class="sc">~</span> LivingArea <span class="sc">+</span> wealthy_neighborhood, </span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">data =</span> boston.sf)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_no_interact)<span class="sc">$</span>coef</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                                Estimate   Std. Error   t value      Pr(&gt;|t|)
(Intercept)                  213842.7642 23893.619394  8.949785  1.039392e-18
LivingArea                      160.2357     9.713346 16.496442  2.936087e-56
wealthy_neighborhoodWealthy 2591012.0471 59958.794614 43.213211 1.103579e-264</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>What This Assumes</p>
<p>Living area has the same effect in all neighborhoods Only the intercept differs (wealthy areas start higher) Parallel lines on a plot</p>
</div>
</div>
<hr>
</section>
<section id="model-2-with-interaction-different-slopes" class="level2">
<h2 class="anchored" data-anchor-id="model-2-with-interaction-different-slopes">Model 2: With Interaction (Different Slopes)</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Model allows different slopes</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>model_interact <span class="ot">&lt;-</span> <span class="fu">lm</span>(SalePrice <span class="sc">~</span> LivingArea <span class="sc">*</span> wealthy_neighborhood, </span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">data =</span> boston.sf)</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_interact)<span class="sc">$</span>coef</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                                            Estimate   Std. Error   t value
(Intercept)                             358542.41696 1.863997e+04 19.235144
LivingArea                                  95.63947 7.620382e+00 12.550483
wealthy_neighborhoodWealthy            -377937.38372 1.005554e+05 -3.758498
LivingArea:wealthy_neighborhoodWealthy     985.12500 2.975904e+01 33.103383
                                            Pr(&gt;|t|)
(Intercept)                             8.875710e-74
LivingArea                              2.079700e-34
wealthy_neighborhoodWealthy             1.775774e-04
LivingArea:wealthy_neighborhoodWealthy 2.445570e-180</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>What This Allows</p>
<p>Living area can have different effects in different neighborhoods Both intercept AND slope differ Non-parallel lines on a plot</p>
</div>
</div>
<hr>
</section>
<section id="interpreting-the-interaction-coefficients" class="level2">
<h2 class="anchored" data-anchor-id="interpreting-the-interaction-coefficients">Interpreting the Interaction Coefficients</h2>
<div class="cell">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Term</th>
<th style="text-align: right;">Coefficient</th>
<th style="text-align: right;">t-value</th>
<th style="text-align: right;">p-value</th>
<th style="text-align: center;">Sig</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Intercept (Not Wealthy)</td>
<td style="text-align: right;">$358,542</td>
<td style="text-align: right;">19.235</td>
<td style="text-align: right;">0</td>
<td style="text-align: center;">***</td>
</tr>
<tr class="even">
<td style="text-align: left;">Living Area (Not Wealthy)</td>
<td style="text-align: right;">$96</td>
<td style="text-align: right;">12.550</td>
<td style="text-align: right;">0</td>
<td style="text-align: center;">***</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Wealthy Neighborhood Premium</td>
<td style="text-align: right;">-$377,937</td>
<td style="text-align: right;">-3.758</td>
<td style="text-align: right;">0</td>
<td style="text-align: center;">***</td>
</tr>
<tr class="even">
<td style="text-align: left;">Extra $/sq ft in Wealthy Areas</td>
<td style="text-align: right;">$985</td>
<td style="text-align: right;">33.103</td>
<td style="text-align: right;">0</td>
<td style="text-align: center;">***</td>
</tr>
</tbody>
</table>
</div>
</div>
<p><em>We get the un-intuitive negative premium here because that is an intercept adjustment (applies at 0 sqft). The slope difference (+985sq/ft) is huge - we can calculate when wealthy areas become more expensive (at what sq ft) = 384.</em></p>
<hr>
</section>
<section id="breaking-down-the-coefficients" class="level2">
<h2 class="anchored" data-anchor-id="breaking-down-the-coefficients">Breaking Down the Coefficients</h2>
<div class="columns">
<div class="column" style="width:50%;">
<p>🏘️ Not Wealthy Areas Equation: Price = $358,542 + $96 × LivingArea Interpretation:</p>
<p>Base price: $358,542 Each sq ft adds: $96</p>
</div><div class="column" style="width:50%;">
<p>🏛️ Wealthy Areas Equation: Price = -$19,395 + $1,081 × LivingArea Interpretation:</p>
<p>Base price: -$19,395 Each sq ft adds: $1,081</p>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>The Interaction Effect Wealthy areas value each sq ft $985 more than non-wealthy areas!</p>
</div>
</div>
<hr>
</section>
<section id="visualizing-the-interaction-effect" class="level2">
<h2 class="anchored" data-anchor-id="visualizing-the-interaction-effect">Visualizing the Interaction Effect</h2>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week-06-class-lab_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>Key Observation: The lines are NOT parallel - that’s the interaction!</p>
<hr>
</section>
<section id="compare-model-performance" class="level2">
<h2 class="anchored" data-anchor-id="compare-model-performance">Compare Model Performance</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare R-squared</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Model WITHOUT interaction R²:"</span>, <span class="fu">round</span>(<span class="fu">summary</span>(model_no_interact)<span class="sc">$</span>r.squared, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Model WITHOUT interaction R²: 0.6156 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Model WITH interaction R²:"</span>, <span class="fu">round</span>(<span class="fu">summary</span>(model_interact)<span class="sc">$</span>r.squared, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Model WITH interaction R²: 0.7791 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Improvement:"</span>, <span class="fu">round</span>(<span class="fu">summary</span>(model_interact)<span class="sc">$</span>r.squared <span class="sc">-</span> <span class="fu">summary</span>(model_no_interact)<span class="sc">$</span>r.squared, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Improvement: 0.1635 </code></pre>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Model Improvement Adding the interaction improves R² by 0.1635 (a 26.6% relative improvement)</p>
<p>Interpretation: We explain 16.35% more variation in prices by allowing different slopes!</p>
</div>
</div>
<hr>
</section>
<section id="policy-implications" class="level2">
<h2 class="anchored" data-anchor-id="policy-implications">Policy Implications</h2>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>What This Tells Us About Boston’s Housing Market
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Market Segmentation: Boston operates as TWO distinct housing markets</li>
</ol>
<ul>
<li>Luxury market: Every sq ft is premium ($1081/sq ft)</li>
<li>Standard market: Space valued, but lower premium ($96/sq ft)</li>
</ul>
<ol start="2" type="1">
<li>Affordability Crisis: The interaction amplifies inequality</li>
</ol>
<ul>
<li>Large homes in wealthy areas become exponentially more expensive</li>
<li>Creates barriers to mobility between neighborhoods</li>
</ul>
<ol start="3" type="1">
<li>Policy Design: One-size-fits-all policies may fail</li>
</ol>
<ul>
<li>Property tax assessments should account for neighborhood-specific valuation</li>
<li>Housing assistance needs vary dramatically by area</li>
</ul>
</div>
</div>
<hr>
</section>
<section id="when-not-to-use-interactions" class="level2">
<h2 class="anchored" data-anchor-id="when-not-to-use-interactions">When Not To Use Interactions</h2>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>When NOT to Use Interactions:</p>
<ul>
<li>Small samples: Need sufficient data in each group</li>
<li>Overfitting: Too many interactions make models unstable</li>
</ul>
</div>
</div>
<hr>
</section>
<section id="polynomial-terms-non-linear-relationships" class="level2">
<h2 class="anchored" data-anchor-id="polynomial-terms-non-linear-relationships">Polynomial Terms: Non-Linear Relationships</h2>
<section id="when-straight-lines-dont-fit" class="level3">
<h3 class="anchored" data-anchor-id="when-straight-lines-dont-fit">When Straight Lines Don’t Fit</h3>
<div class="columns">
<div class="column" style="width:50%;">
<p><strong>Signs of Non-Linearity:</strong></p>
<ul>
<li>Curved residual plots</li>
<li>Diminishing returns</li>
<li>Accelerating effects</li>
<li>U-shaped or inverted-U patterns</li>
<li>Theoretical reasons</li>
</ul>
</div><div class="column" style="width:50%;">
<p><strong>Examples:</strong></p>
<ul>
<li>House age: depreciation then vintage premium</li>
<li>Test scores: plateau after studying</li>
<li>Advertising: diminishing returns</li>
<li>Crime prevention: early gains, then plateaus</li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>Polynomial Regression
</div>
</div>
<div class="callout-body-container callout-body">
<p>SalePrice = β₀ + β₁(Age) + β₂(Age²) + ε</p>
<p>This allows for a <strong>curved relationship</strong></p>
</div>
</div>
<hr>
</section>
</section>
<section id="theory-the-u-shaped-age-effect" class="level2">
<h2 class="anchored" data-anchor-id="theory-the-u-shaped-age-effect">Theory: The U-Shaped Age Effect</h2>
<section id="why-would-age-have-a-non-linear-effect" class="level3">
<h3 class="anchored" data-anchor-id="why-would-age-have-a-non-linear-effect">Why Would Age Have a Non-Linear Effect?</h3>
</section>
<div class="columns">
<div class="column" style="width:33%;">
<section id="new-houses" class="level3">
<h3 class="anchored" data-anchor-id="new-houses">🏗️ New Houses</h3>
<p>(0-20 years)</p>
<ul>
<li>Modern amenities</li>
<li>Move-in ready</li>
<li>No repairs needed</li>
<li><strong>High value</strong></li>
<li>Steep depreciation initially</li>
</ul>
</section>
</div><div class="column" style="width:33%;">
<section id="middle-aged" class="level3">
<h3 class="anchored" data-anchor-id="middle-aged">🏠 Middle-Aged</h3>
<p>(20-80 years)</p>
<ul>
<li>Needs updates</li>
<li>Wear and tear</li>
<li>Not yet “historic”</li>
<li><strong>Lowest value</strong></li>
<li>Trough of the curve</li>
</ul>
</section>
</div><div class="column" style="width:33%;">
<section id="historicvintage" class="level3">
<h3 class="anchored" data-anchor-id="historicvintage">🏛️ Historic/Vintage</h3>
<p>(80+ years)</p>
<ul>
<li>Architectural character</li>
<li>Historic districts</li>
<li>Prestige value</li>
<li><strong>Rising value</strong></li>
<li>“Vintage premium”</li>
</ul>
</section>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Boston Context
</div>
</div>
<div class="callout-body-container callout-body">
<p>Boston has LOTS of historic homes (Back Bay, Beacon Hill built 1850s-1900s). Does age create a U-shaped curve?</p>
</div>
</div>
</section>
<section id="create-age-variable" class="level2">
<h2 class="anchored" data-anchor-id="create-age-variable">Create Age Variable</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate age from year built</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>boston.sf <span class="ot">&lt;-</span> boston.sf <span class="sc">%&gt;%</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Age =</span> <span class="dv">2025</span> <span class="sc">-</span> YR_BUILT)<span class="sc">%&gt;%</span> <span class="fu">filter</span>(Age <span class="sc">&lt;</span><span class="dv">2000</span>)</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the distribution of age</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(boston.sf<span class="sc">$</span>Age)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   12.0    95.0   115.0   108.1   125.0   223.0 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize age distribution</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(boston.sf, <span class="fu">aes</span>(<span class="at">x =</span> Age)) <span class="sc">+</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">30</span>, <span class="at">fill =</span> <span class="st">"steelblue"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Distribution of House Age in Boston"</span>,</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Age (years)"</span>,</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Count"</span>) <span class="sc">+</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week-06-class-lab_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
<section id="first-linear-model-baseline" class="level2">
<h2 class="anchored" data-anchor-id="first-linear-model-baseline">First: Linear Model (Baseline)</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple linear relationship</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>model_age_linear <span class="ot">&lt;-</span> <span class="fu">lm</span>(SalePrice <span class="sc">~</span> Age <span class="sc">+</span> LivingArea, <span class="at">data =</span> boston.sf)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_age_linear)<span class="sc">$</span>coef</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                Estimate  Std. Error   t value     Pr(&gt;|t|)
(Intercept) -120808.8738 57836.98918 -2.088782 3.689911e-02
Age            2834.0198   497.72013  5.694003 1.496246e-08
LivingArea      202.8312    15.10373 13.429214 7.228187e-39</code></pre>
</div>
</div>
<p>Interpretation: Each additional year of age changes price by $2834.01 (assumed constant rate)</p>
<hr>
</section>
<section id="visualize-is-the-relationship-linear" class="level2">
<h2 class="anchored" data-anchor-id="visualize-is-the-relationship-linear">Visualize: Is the relationship Linear?</h2>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'
`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week-06-class-lab_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
<section id="add-polynomial-term-age-squared" class="level2">
<h2 class="anchored" data-anchor-id="add-polynomial-term-age-squared">Add Polynomial Term: Age Squared</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Quadratic model (Age²)</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>model_age_quad <span class="ot">&lt;-</span> <span class="fu">lm</span>(SalePrice <span class="sc">~</span> Age <span class="sc">+</span> <span class="fu">I</span>(Age<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> LivingArea, <span class="at">data =</span> boston.sf)</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_age_quad)<span class="sc">$</span>coef</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                Estimate   Std. Error   t value     Pr(&gt;|t|)
(Intercept) 570397.14406 97894.237962  5.826667 6.938345e-09
Age         -13007.51918  1896.446156 -6.858892 1.019524e-11
I(Age^2)        80.88988     9.360652  8.641479 1.425208e-17
LivingArea     203.75007    14.739041 13.823835 5.975020e-41</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>The I() Function Why I(Age^2) instead of just Age^2? In R formulas, ^ has special meaning. I() tells R: “interpret this literally, compute Age²” Without I(): R would interpret it differently in the formula</p>
</div>
</div>
<hr>
</section>
<section id="interpreting-polynomial-coefficients" class="level2">
<h2 class="anchored" data-anchor-id="interpreting-polynomial-coefficients">Interpreting Polynomial Coefficients</h2>
<p>Model equation: Price = $570,397 + -$13,008×Age + $80×Age² + $204×LivingArea</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>⚠️ Can’t Interpret Coefficients Directly!</p>
<p>With Age², the effect of age is no longer constant. You need to calculate the marginal effect. Marginal effect of Age = β₁ + 2×β₂×Age This means the effect changes at every age!</p>
</div>
</div>
<hr>
</section>
<section id="compare-model-performance-1" class="level2">
<h2 class="anchored" data-anchor-id="compare-model-performance-1">Compare Model Performance</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># R-squared comparison</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>r2_linear <span class="ot">&lt;-</span> <span class="fu">summary</span>(model_age_linear)<span class="sc">$</span>r.squared</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>r2_quad <span class="ot">&lt;-</span> <span class="fu">summary</span>(model_age_quad)<span class="sc">$</span>r.squared</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Linear model R²:"</span>, <span class="fu">round</span>(r2_linear, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Linear model R²: 0.1549 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Quadratic model R²:"</span>, <span class="fu">round</span>(r2_quad, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Quadratic model R²: 0.1959 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Improvement:"</span>, <span class="fu">round</span>(r2_quad <span class="sc">-</span> r2_linear, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Improvement: 0.0409 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># F-test: Is the Age² term significant?</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(model_age_linear, model_age_quad)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Analysis of Variance Table

Model 1: SalePrice ~ Age + LivingArea
Model 2: SalePrice ~ Age + I(Age^2) + LivingArea
  Res.Df        RSS Df  Sum of Sq      F    Pr(&gt;F)    
1   1469 4.5786e+14                                   
2   1468 4.3569e+14  1 2.2163e+13 74.675 &lt; 2.2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<hr>
</section>
<section id="check-residual-plot" class="level2">
<h2 class="anchored" data-anchor-id="check-residual-plot">Check Residual Plot</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare residual plots</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Linear model residuals</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">fitted</span>(model_age_linear), <span class="fu">residuals</span>(model_age_linear),</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Linear Model Residuals"</span>,</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Fitted Values"</span>, <span class="at">ylab =</span> <span class="st">"Residuals"</span>)</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Quadratic model residuals  </span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">fitted</span>(model_age_quad), <span class="fu">residuals</span>(model_age_quad),</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Quadratic Model Residuals"</span>,</span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Fitted Values"</span>, <span class="at">ylab =</span> <span class="st">"Residuals"</span>)</span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week-06-class-lab_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
</section>
<section id="part-3-creating-spatial-features" class="level1" data-background-color="#667eea">
<h1 data-background-color="#667eea">Part 3: Creating Spatial Features</h1>
<hr>
<section id="why-space-matters-for-housing-prices" class="level2">
<h2 class="anchored" data-anchor-id="why-space-matters-for-housing-prices">Why Space Matters for Housing Prices</h2>
<section id="toblers-first-law-of-geography" class="level3">
<h3 class="anchored" data-anchor-id="toblers-first-law-of-geography">Tobler’s First Law of Geography</h3>
<div class="callout callout-style-simple callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>“Everything is related to everything else, but near things are more related than distant things”
</div>
</div>
<div class="callout-body-container callout-body">
<p><em>- Waldo Tobler, 1970</em></p>
</div>
</div>
</section>
<section id="what-this-means-for-house-prices" class="level3">
<h3 class="anchored" data-anchor-id="what-this-means-for-house-prices">What This Means for House Prices</h3>
<ul>
<li>Crime <strong>nearby</strong> matters more than crime across the city</li>
<li>Parks <strong>within walking distance</strong> affect value</li>
<li>Your <strong>immediate neighborhood</strong> defines your market</li>
</ul>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>The Challenge
</div>
</div>
<div class="callout-body-container callout-body">
<p>How do we quantify “nearbyness” in a way our regression model can use?</p>
<p><strong>Answer:</strong> Create spatial features that measure proximity to amenities/disamenities</p>
</div>
</div>
<hr>
</section>
</section>
<section id="three-approaches-to-spatial-features" class="level2">
<h2 class="anchored" data-anchor-id="three-approaches-to-spatial-features">Three Approaches to Spatial Features</h2>
<section id="buffer-aggregation" class="level3">
<h3 class="anchored" data-anchor-id="buffer-aggregation">1️⃣ Buffer Aggregation</h3>
<p><strong>Count or sum</strong> events within a defined distance</p>
<p><em>Example: Number of crimes within 500 feet</em></p>
</section>
<section id="k-nearest-neighbors-knn" class="level3">
<h3 class="anchored" data-anchor-id="k-nearest-neighbors-knn">2️⃣ k-Nearest Neighbors (kNN)</h3>
<p><strong>Average distance</strong> to k closest events</p>
<p><em>Example: Average distance to 3 nearest violent crimes</em></p>
</section>
<section id="distance-to-specific-points" class="level3">
<h3 class="anchored" data-anchor-id="distance-to-specific-points">3️⃣ Distance to Specific Points</h3>
<p><strong>Straight-line distance</strong> to important locations</p>
<p><em>Example: Distance to downtown, nearest T station</em></p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Today:</strong> We’ll create all three types using Boston crime data!</p>
</div>
</div>
<hr>
</section>
</section>
<section id="load-and-prepare-crime-data" class="level2">
<h2 class="anchored" data-anchor-id="load-and-prepare-crime-data">Load and Prepare Crime Data</h2>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>New names:
Rows: 200977 Columns: 21
── Column specification
──────────────────────────────────────────────────────── Delimiter: "," chr
(9): STREET, OFFENSE_DESCRIPTION, SHOOTING, DISTRICT, DAY_OF_WEEK, INC... dbl
(11): ...1, OFFENSE_CODE, REPORTING_AREA, MONTH, HOUR, X_full_count, Lo... dttm
(1): OCCURRED_ON_DATE
ℹ Use `spec()` to retrieve the full column specification for this data. ℹ
Specify the column types or set `show_col_types = FALSE` to quiet this message.
• `` -&gt; `...1`</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 200,977
Columns: 21
$ ...1                &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15,…
$ STREET              &lt;chr&gt; "ALBERT ST", "ALBERT ST", "L ST", "HAROLD ST", "BL…
$ OFFENSE_DESCRIPTION &lt;chr&gt; "DRUGS - POSS CLASS B - INTENT TO MFR DIST DISP", …
$ SHOOTING            &lt;chr&gt; NA, NA, NA, "Y", NA, NA, NA, NA, NA, NA, NA, NA, N…
$ OFFENSE_CODE        &lt;dbl&gt; 1843, 1841, 2900, 413, 3111, 2900, 3402, 1841, 311…
$ DISTRICT            &lt;chr&gt; "B2", "B2", "C6", "B2", "B3", "B3", "A1", "D4", "E…
$ REPORTING_AREA      &lt;dbl&gt; NA, NA, 230, 314, 465, 406, 76, 270, 499, 356, 170…
$ OCCURRED_ON_DATE    &lt;dttm&gt; 2015-08-01 23:07:00, 2015-08-01 23:07:00, 2015-08…
$ DAY_OF_WEEK         &lt;chr&gt; "Saturday", "Saturday", "Saturday", "Saturday", "S…
$ MONTH               &lt;dbl&gt; 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8,…
$ HOUR                &lt;dbl&gt; 23, 23, 8, 18, 1, 1, 1, 17, 15, 13, 19, 12, 1, 1, …
$ X_full_count        &lt;dbl&gt; 273, 273, 273, 273, 273, 273, 273, 273, 273, 273, …
$ Long                &lt;dbl&gt; NA, NA, -71.03529, -71.09072, -71.09104, -71.07442…
$ YEAR                &lt;dbl&gt; 2015, 2015, 2015, 2015, 2015, 2015, 2015, 2015, 20…
$ Lat                 &lt;dbl&gt; NA, NA, 42.33271, 42.31532, 42.28582, 42.27130, 42…
$ INCIDENT_NUMBER     &lt;chr&gt; "I152063654", "I152063654", "I152063493", "I152063…
$ rank                &lt;dbl&gt; 0.314183, 0.314366, 0.314974, 0.315240, 0.315467, …
$ X_id                &lt;dbl&gt; 243806, 243805, 243949, 243858, 244025, 244015, 24…
$ OFFENSE_CODE_GROUP  &lt;chr&gt; "Drug Violation", "Drug Violation", "Other", "Aggr…
$ UCR_PART            &lt;chr&gt; "Part Two", "Part Two", "Part Two", "Part One", "P…
$ Location            &lt;chr&gt; "(0.00000000, 0.00000000)", "(0.00000000, 0.000000…</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `BPDA_Neighborhood_Boundaries' from data source 
  `C:\Users\Tess\Documents\GitHub\portfolio-setup-TessaVu\weekly-notes\week-06\data\BPDA_Neighborhood_Boundaries.geojson' 
  using driver `GeoJSON'
Simple feature collection with 26 features and 7 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: -71.19125 ymin: 42.22792 xmax: -70.92278 ymax: 42.39699
Geodetic CRS:  WGS 84</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>    xmin     ymin     xmax     ymax 
227125.8 886966.0 241483.7 904797.2 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>    xmin     ymin     xmax     ymax 
226505.0 887148.3 241435.5 904894.0 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>    xmin     ymin     xmax     ymax 
225465.6 886449.8 247575.8 905284.0 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Records with missing coordinates: 10103 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Violent crime records: 39854 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 2
  OFFENSE_CODE_GROUP             n
  &lt;chr&gt;                      &lt;int&gt;
1 Larceny                    16485
2 Larceny From Motor Vehicle  7899
3 Aggravated Assault          4618
4 Residential Burglary        4263
5 Robbery                     3083
6 Auto Theft                  2380
7 Commercial Burglary          754
8 Other Burglary               286
9 Homicide                      86</code></pre>
</div>
</div>
<hr>
</section>
<section id="visaulize-crime-locations" class="level2">
<h2 class="anchored" data-anchor-id="visaulize-crime-locations">Visaulize: Crime Locations</h2>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week-06-class-lab_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
<section id="approach-1-buffer-aggregation" class="level2">
<h2 class="anchored" data-anchor-id="approach-1-buffer-aggregation">Approach 1: Buffer Aggregation</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create buffer features - these will work now that CRS is correct</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>boston.sf <span class="ot">&lt;-</span> boston.sf <span class="sc">%&gt;%</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">crimes.Buffer =</span> <span class="fu">lengths</span>(<span class="fu">st_intersects</span>(</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_buffer</span>(geometry, <span class="dv">660</span>),</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>      crimes.sf</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>    )),</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">crimes_500ft =</span> <span class="fu">lengths</span>(<span class="fu">st_intersects</span>(</span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_buffer</span>(geometry, <span class="dv">500</span>),</span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>      crimes.sf</span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Check it worked</span></span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a><span class="co">#summary(boston.sf$crimes.Buffer)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week-06-class-lab_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
<section id="approach-2-k-nearest-neighborhoods-method" class="level2">
<h2 class="anchored" data-anchor-id="approach-2-k-nearest-neighborhoods-method">Approach 2: k-Nearest Neighborhoods Method</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate distance matrix (houses to crimes)</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>dist_matrix <span class="ot">&lt;-</span> <span class="fu">st_distance</span>(boston.sf, crimes.sf)</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to get mean distance to k nearest neighbors</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>get_knn_distance <span class="ot">&lt;-</span> <span class="cf">function</span>(dist_matrix, k) {</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">apply</span>(dist_matrix, <span class="dv">1</span>, <span class="cf">function</span>(distances) {</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort and take first k, then average</span></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>(<span class="fu">as.numeric</span>(<span class="fu">sort</span>(distances)[<span class="dv">1</span><span class="sc">:</span>k]))</span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Create multiple kNN features</span></span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a>boston.sf <span class="ot">&lt;-</span> boston.sf <span class="sc">%&gt;%</span></span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">crime_nn1 =</span> <span class="fu">get_knn_distance</span>(dist_matrix, <span class="at">k =</span> <span class="dv">1</span>),</span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">crime_nn3 =</span> <span class="fu">get_knn_distance</span>(dist_matrix, <span class="at">k =</span> <span class="dv">3</span>),</span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">crime_nn5 =</span> <span class="fu">get_knn_distance</span>(dist_matrix, <span class="at">k =</span> <span class="dv">5</span>)</span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Check results</span></span>
<span id="cb84-21"><a href="#cb84-21" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(boston.sf <span class="sc">%&gt;%</span> <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"crime_nn"</span>)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   crime_nn1         crime_nn3         crime_nn5     
 Min.   :  9.372   Min.   :  9.372   Min.   : 10.67  
 1st Qu.: 29.944   1st Qu.: 37.615   1st Qu.: 44.30  
 Median : 54.036   Median : 62.835   Median : 70.27  
 Mean   : 70.750   Mean   : 83.298   Mean   : 94.66  
 3rd Qu.: 90.145   3rd Qu.:107.735   3rd Qu.:127.14  
 Max.   :596.529   Max.   :637.559   Max.   :683.53  </code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Interpretation: crime_nn3 = 83.29 means the average distance to the 3 nearest crimes is 83.29 feet</p>
</div>
</div>
<hr>
</section>
<section id="which-k-value-correlates-most-with-price" class="level2">
<h2 class="anchored" data-anchor-id="which-k-value-correlates-most-with-price">Which k value correlates most with price?</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Which k value correlates most with price?</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>boston.sf <span class="sc">%&gt;%</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(SalePrice, crime_nn1, crime_nn3, crime_nn5) <span class="sc">%&gt;%</span></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cor</span>(<span class="at">use =</span> <span class="st">"complete.obs"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(SalePrice)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>            SalePrice
SalePrice  1.00000000
crime_nn1 -0.07317564
crime_nn3 -0.08726806
crime_nn5 -0.09599580</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Finding: The kNN feature with the strongest correlation tells us the relevant “zone of influence” for crime perception!</p>
</div>
</div>
<hr>
<p>Approach 3: Distance to Downtown</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define downtown Boston (Boston Common: 42.3551° N, 71.0656° W)</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>downtown <span class="ot">&lt;-</span> <span class="fu">st_sfc</span>(<span class="fu">st_point</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="fl">71.0656</span>, <span class="fl">42.3551</span>)), <span class="at">crs =</span> <span class="st">"EPSG:4326"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="st">'ESRI:102286'</span>)</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate distance from each house to downtown</span></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>boston.sf <span class="ot">&lt;-</span> boston.sf <span class="sc">%&gt;%</span></span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">dist_downtown_ft =</span> <span class="fu">as.numeric</span>(<span class="fu">st_distance</span>(geometry, downtown)),</span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">dist_downtown_mi =</span> dist_downtown_ft <span class="sc">/</span> <span class="dv">5280</span></span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary</span></span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(boston.sf<span class="sc">$</span>dist_downtown_mi)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
0.05467 0.80699 1.37601 1.39335 1.94227 2.77678 </code></pre>
</div>
</div>
<hr>
<section id="all-spatial-features-together" class="level3">
<h3 class="anchored" data-anchor-id="all-spatial-features-together">All spatial features together</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary of all spatial features created</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>spatial_summary <span class="ot">&lt;-</span> boston.sf <span class="sc">%&gt;%</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(crimes.Buffer, crimes_500ft, crime_nn3, dist_downtown_mi) <span class="sc">%&gt;%</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>()</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>spatial_summary</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> crimes.Buffer     crimes_500ft      crime_nn3       dist_downtown_mi 
 Min.   :   4.0   Min.   :   0.0   Min.   :  9.372   Min.   :0.05467  
 1st Qu.: 105.0   1st Qu.:  63.0   1st Qu.: 37.615   1st Qu.:0.80699  
 Median : 323.0   Median : 188.0   Median : 62.835   Median :1.37601  
 Mean   : 440.2   Mean   : 261.9   Mean   : 83.298   Mean   :1.39335  
 3rd Qu.: 737.0   3rd Qu.: 427.0   3rd Qu.:107.735   3rd Qu.:1.94227  
 Max.   :3108.0   Max.   :2088.0   Max.   :637.559   Max.   :2.77678  </code></pre>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 29%">
<col style="width: 20%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Feature</th>
<th style="text-align: left;">Type</th>
<th style="text-align: left;">What it Measures</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">crimes.Buffer (660ft)</td>
<td style="text-align: left;">Buffer count</td>
<td style="text-align: left;">Number of crimes near house</td>
</tr>
<tr class="even">
<td style="text-align: left;">crimes_500ft</td>
<td style="text-align: left;">Buffer count</td>
<td style="text-align: left;">Crimes within 500ft</td>
</tr>
<tr class="odd">
<td style="text-align: left;">crime_nn3</td>
<td style="text-align: left;">kNN distance</td>
<td style="text-align: left;">Avg distance to 3 nearest crimes (ft)</td>
</tr>
<tr class="even">
<td style="text-align: left;">dist_downtown_mi</td>
<td style="text-align: left;">Point distance</td>
<td style="text-align: left;">Miles from downtown Boston</td>
</tr>
</tbody>
</table>
</div>
</div>
<hr>
</section>
<section id="model-comparison-adding-spatial-features" class="level3">
<h3 class="anchored" data-anchor-id="model-comparison-adding-spatial-features">Model Comparison: Adding Spatial Features</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>boston.sf <span class="ot">&lt;-</span> boston.sf <span class="sc">%&gt;%</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Age =</span> <span class="dv">2015</span> <span class="sc">-</span> YR_BUILT)  </span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 1: Structural only</span></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>model_structural <span class="ot">&lt;-</span> <span class="fu">lm</span>(SalePrice <span class="sc">~</span> LivingArea <span class="sc">+</span> R_BDRMS <span class="sc">+</span> Age, </span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> boston.sf)</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 2: Add spatial features</span></span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>model_spatial <span class="ot">&lt;-</span> <span class="fu">lm</span>(SalePrice <span class="sc">~</span> LivingArea <span class="sc">+</span> R_BDRMS <span class="sc">+</span> Age <span class="sc">+</span></span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>                    crimes_500ft <span class="sc">+</span> crime_nn3 <span class="sc">+</span> dist_downtown_mi,</span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> boston.sf)</span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare</span></span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Structural R²:"</span>, <span class="fu">round</span>(<span class="fu">summary</span>(model_structural)<span class="sc">$</span>r.squared, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Structural R²: 0.2169 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"With spatial R²:"</span>, <span class="fu">round</span>(<span class="fu">summary</span>(model_spatial)<span class="sc">$</span>r.squared, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>With spatial R²: 0.3529 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Improvement:"</span>, <span class="fu">round</span>(<span class="fu">summary</span>(model_spatial)<span class="sc">$</span>r.squared <span class="sc">-</span> </span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">summary</span>(model_structural)<span class="sc">$</span>r.squared, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Improvement: 0.136 </code></pre>
</div>
</div>
<hr>
</section>
</section>
</section>
<section id="part-3-fixed-effects" class="level1" data-background-color="#667eea">
<h1 data-background-color="#667eea">Part 3: Fixed Effects</h1>
<hr>
<section id="what-are-fixed-effects" class="level2">
<h2 class="anchored" data-anchor-id="what-are-fixed-effects">What Are Fixed Effects?</h2>
<p><strong>Fixed Effects</strong> = Categorical variables that capture <strong>all unmeasured characteristics</strong> of a group</p>
<p><strong>In hedonic models:</strong></p>
<ul>
<li>Each neighborhood gets its own dummy variable</li>
<li>Captures everything unique about that neighborhood we didn’t explicitly measure</li>
</ul>
<p><em>We technically already did this when I went over categorical data!</em></p>
<div class="columns">
<div class="column" style="width:50%;">
<p><strong>What They Capture:</strong></p>
<ul>
<li>School quality</li>
<li>“Prestige” or reputation</li>
<li>Walkability</li>
<li>Access to jobs</li>
<li>Cultural amenities</li>
<li>Things we <strong>can’t easily measure</strong></li>
</ul>
</div><div class="column" style="width:50%;">
<p><strong>The Code:</strong></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add neighborhood fixed effects</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>reg5 <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>  SalePrice <span class="sc">~</span> LivingArea <span class="sc">+</span> Age <span class="sc">+</span> </span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>              crimes_500ft <span class="sc">+</span> </span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>              parks_nn3 <span class="sc">+</span> </span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>              <span class="fu">as.factor</span>(name),  <span class="co"># FE</span></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> boston.sf</span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>R creates a dummy for each neighborhood automatically!</p>
</div>
</div>
<hr>
</section>
<section id="how-fixed-effects-work" class="level2">
<h2 class="anchored" data-anchor-id="how-fixed-effects-work">How Fixed Effects Work</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Behind the scenes, R creates dummies:</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="co"># is_BackBay = 1 if Back Bay, 0 otherwise</span></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a><span class="co"># is_Beacon = 1 if Beacon Hill, 0 otherwise</span></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a><span class="co"># is_Allston = 1 if Allston, 0 otherwise</span></span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ... (R drops one as reference category)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p><strong>Interpretation Example:</strong></p>
<pre><code>Coefficients:
(Intercept)           50000
LivingArea              150
nameBack_Bay          85000   ← $85k premium vs. reference
nameBeacon_Hill      125000   ← $125k premium  
nameAllston          -15000   ← $15k discount</code></pre>
<p><strong>Each coefficient = price premium/discount for that neighborhood</strong> (holding all else constant)</p>
<hr>
</section>
<section id="why-use-fixed-effects" class="level2">
<h2 class="anchored" data-anchor-id="why-use-fixed-effects">Why Use Fixed Effects?</h2>
<div class="columns">
<div class="column" style="width:50%;">
<section id="dramatically-improve-prediction" class="level3">
<h3 class="anchored" data-anchor-id="dramatically-improve-prediction">Dramatically Improve Prediction</h3>
<pre><code>Model Comparison (R²):
- Structural only:     0.58
- + Spatial features:  0.67
- + Fixed Effects:     0.81 ✓</code></pre>
<p><strong>Why such a big jump?</strong></p>
<ul>
<li>Neighborhoods bundle many unmeasured factors</li>
<li>School districts</li>
<li>Job access</li>
<li>Amenities</li>
<li>“Cool factor”</li>
</ul>
</section>
</div><div class="column" style="width:50%;">
<section id="coefficients-change" class="level3">
<h3 class="anchored" data-anchor-id="coefficients-change">Coefficients Change</h3>
<p><strong>Crime coefficient:</strong></p>
<ul>
<li>Without FE: -$125/crime</li>
<li>With FE: -$85/crime</li>
</ul>
<p><strong>Why?</strong></p>
<ul>
<li>Without FE: captured neighborhood confounders too</li>
<li>With FE: neighborhoods “absorb” other differences</li>
<li>Now just the crime effect</li>
</ul>
</section>
</div>
</div>
<p><strong>Trade-off:</strong> FE are powerful but they’re a <strong>black box</strong> - we don’t know WHY Back Bay commands a premium</p>
<hr>
</section>
<section id="lets-compare-all-our-models" class="level2">
<h2 class="anchored" data-anchor-id="lets-compare-all-our-models">Let’s Compare All Our Models</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 3: Structural Only</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>reg3 <span class="ot">&lt;-</span> <span class="fu">lm</span>(SalePrice <span class="sc">~</span> LivingArea <span class="sc">+</span> Age <span class="sc">+</span> R_FULL_BTH, </span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> boston.sf)</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 4: Add Spatial Features  </span></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>reg4 <span class="ot">&lt;-</span> <span class="fu">lm</span>(SalePrice <span class="sc">~</span> LivingArea <span class="sc">+</span> Age <span class="sc">+</span> R_FULL_BTH <span class="sc">+</span></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>                       crimes_500ft <span class="sc">+</span> crime_nn3<span class="sc">+</span> dist_downtown_mi,</span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> boston.sf)</span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a>boston.sf <span class="ot">&lt;-</span> boston.sf <span class="sc">%&gt;%</span></span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_join</span>(nhoods, <span class="at">join =</span> st_intersects)</span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 5: Add Fixed Effects</span></span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a>reg5 <span class="ot">&lt;-</span> <span class="fu">lm</span>(SalePrice <span class="sc">~</span> LivingArea <span class="sc">+</span> Age <span class="sc">+</span> R_FULL_BTH <span class="sc">+</span></span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a>                       crimes_500ft <span class="sc">+</span> crime_nn3<span class="sc">+</span> dist_downtown_mi <span class="sc">+</span></span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">as.factor</span>(name),</span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> boston.sf)</span>
<span id="cb102-18"><a href="#cb102-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stargazer)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>
Please cite as: </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> Hlavac, Marek (2022). stargazer: Well-Formatted Regression and Summary Statistics Tables.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> R package version 5.2.3. https://CRAN.R-project.org/package=stargazer </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare in-sample fit</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="fu">stargazer</span>(reg3, reg4, reg5, <span class="at">type =</span> <span class="st">"text"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
=========================================================================================================
                                                         Dependent variable:                             
                             ----------------------------------------------------------------------------
                                                              SalePrice                                  
                                       (1)                      (2)                       (3)            
---------------------------------------------------------------------------------------------------------
LivingArea                          148.860***               111.501***                118.107***        
                                     (21.242)                 (20.077)                  (8.586)          
                                                                                                         
Age                                 322.029***                123.069                  212.973***        
                                     (80.730)                 (75.779)                  (30.508)         
                                                                                                         
R_FULL_BTH                        113,372.800***            40,173.330*              50,895.880***       
                                   (23,735.650)             (22,987.460)              (9,458.101)        
                                                                                                         
crimes_500ft                                                 762.817***               -211.220***        
                                                              (85.812)                  (42.796)         
                                                                                                         
crime_nn3                                                   2,219.712***               466.580***        
                                                             (242.880)                 (105.506)         
                                                                                                         
dist_downtown_mi                                          -202,215.700***           -103,165.100***      
                                                            (29,626.430)              (30,260.730)       
                                                                                                         
as.factor(name)Back Bay                                                             7,668,782.000***     
                                                                                     (152,445.600)       
                                                                                                         
as.factor(name)Bay Village                                                          1,374,060.000***     
                                                                                     (225,127.300)       
                                                                                                         
as.factor(name)Beacon Hill                                                          1,720,668.000***     
                                                                                     (101,788.600)       
                                                                                                         
as.factor(name)Brighton                                                               -186,898.400       
                                                                                     (120,211.300)       
                                                                                                         
as.factor(name)Charlestown                                                            -99,353.820        
                                                                                      (92,604.600)       
                                                                                                         
as.factor(name)Dorchester                                                           -555,954.300***      
                                                                                      (85,853.130)       
                                                                                                         
as.factor(name)Downtown                                                               216,317.000        
                                                                                     (226,782.100)       
                                                                                                         
as.factor(name)East Boston                                                          -574,986.800***      
                                                                                      (87,455.850)       
                                                                                                         
as.factor(name)Fenway                                                               1,034,562.000***     
                                                                                     (169,543.800)       
                                                                                                         
as.factor(name)Hyde Park                                                            -480,342.800***      
                                                                                      (93,199.370)       
                                                                                                         
as.factor(name)Jamaica Plain                                                         -198,209.800**      
                                                                                      (87,603.690)       
                                                                                                         
as.factor(name)Mattapan                                                             -561,786.900***      
                                                                                      (90,587.160)       
                                                                                                         
as.factor(name)Mission Hill                                                          214,567.100**       
                                                                                     (101,389.300)       
                                                                                                         
as.factor(name)Roslindale                                                           -442,450.500***      
                                                                                      (89,746.210)       
                                                                                                         
as.factor(name)Roxbury                                                              -592,878.500***      
                                                                                      (88,945.650)       
                                                                                                         
as.factor(name)South Boston                                                         -290,863.400***      
                                                                                      (90,664.580)       
                                                                                                         
as.factor(name)South End                                                            1,750,702.000***     
                                                                                      (98,722.040)       
                                                                                                         
as.factor(name)West Roxbury                                                         -380,868.400***      
                                                                                      (91,694.890)       
                                                                                                         
Constant                            50,899.030             199,477.900***            778,604.600***      
                                   (39,788.170)             (70,002.400)             (100,039.000)       
                                                                                                         
---------------------------------------------------------------------------------------------------------
Observations                          1,485                    1,485                     1,485           
R2                                    0.152                    0.276                     0.885           
Adjusted R2                           0.150                    0.273                     0.883           
Residual Std. Error          557,399.300 (df = 1481)  515,703.200 (df = 1478)   206,473.300 (df = 1460)  
F Statistic                  88.527*** (df = 3; 1481) 93.739*** (df = 6; 1478) 469.541*** (df = 24; 1460)
=========================================================================================================
Note:                                                                         *p&lt;0.1; **p&lt;0.05; ***p&lt;0.01</code></pre>
</div>
</div>
<p><strong>But in-sample R² can be misleading! We need cross-validation…</strong></p>
<hr>
</section>
</section>
<section id="part-5-cross-validation-with-categorical-variables" class="level1" data-background-color="#667eea">
<h1 data-background-color="#667eea">Part 5: Cross-Validation (with Categorical Variables)</h1>
<hr>
<section id="cv-recap-from-last-week" class="level2">
<h2 class="anchored" data-anchor-id="cv-recap-from-last-week">CV Recap (From Last Week)</h2>
<p><strong>Three common validation approaches:</strong></p>
<ol type="1">
<li><strong>Train/Test Split</strong> - 80/20 split, simple but unstable</li>
<li><strong>k-Fold Cross-Validation</strong> - Split into k folds, train on k-1, test on 1, repeat</li>
<li><strong>LOOCV</strong> - Leave one observation out at a time (special case of <em>k</em>-fold)</li>
</ol>
<p><strong>Today we’ll use k-fold CV</strong> to compare our hedonic models</p>
<div class="columns">
<div class="column" style="width:50%;">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: lattice</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'caret'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:purrr':

    lift</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>ctrl <span class="ot">&lt;-</span> <span class="fu">trainControl</span>(</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"cv"</span>,</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">number =</span> <span class="dv">10</span>  <span class="co"># 10-fold CV</span></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>model_cv <span class="ot">&lt;-</span> <span class="fu">train</span>(</span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>  SalePrice <span class="sc">~</span> LivingArea <span class="sc">+</span> Age,</span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> boston.sf,</span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"lm"</span>,</span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">trControl =</span> ctrl</span>
<span id="cb112-11"><a href="#cb112-11" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</div><div class="column" style="width:50%;">
<p><strong>Why CV?</strong></p>
<ul>
<li>Tells us how well model predicts NEW data</li>
<li>More honest than in-sample R²</li>
<li>Helps detect overfitting</li>
</ul>
</div>
</div>
<hr>
</section>
<section id="comparing-models-with-cv" class="level2">
<h2 class="anchored" data-anchor-id="comparing-models-with-cv">Comparing Models with CV</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>ctrl <span class="ot">&lt;-</span> <span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">"cv"</span>, <span class="at">number =</span> <span class="dv">10</span>)</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 1: Structural</span></span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>cv_m1 <span class="ot">&lt;-</span> <span class="fu">train</span>(</span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>  SalePrice <span class="sc">~</span> LivingArea <span class="sc">+</span> Age <span class="sc">+</span> R_FULL_BTH,</span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> boston.sf, <span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">trControl =</span> ctrl</span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 2: + Spatial</span></span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true" tabindex="-1"></a>cv_m2 <span class="ot">&lt;-</span> <span class="fu">train</span>(</span>
<span id="cb113-12"><a href="#cb113-12" aria-hidden="true" tabindex="-1"></a>  SalePrice <span class="sc">~</span> LivingArea <span class="sc">+</span> Age <span class="sc">+</span> R_FULL_BTH <span class="sc">+</span> crimes_500ft <span class="sc">+</span> crime_nn3,</span>
<span id="cb113-13"><a href="#cb113-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> boston.sf, <span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">trControl =</span> ctrl</span>
<span id="cb113-14"><a href="#cb113-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb113-15"><a href="#cb113-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-16"><a href="#cb113-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 3: + Fixed Effects (BUT WAIT - there's a (potential) problem!)</span></span>
<span id="cb113-17"><a href="#cb113-17" aria-hidden="true" tabindex="-1"></a>cv_m3 <span class="ot">&lt;-</span> <span class="fu">train</span>(</span>
<span id="cb113-18"><a href="#cb113-18" aria-hidden="true" tabindex="-1"></a>  SalePrice <span class="sc">~</span> LivingArea <span class="sc">+</span> Age <span class="sc">+</span> R_FULL_BTH <span class="sc">+</span> crimes_500ft <span class="sc">+</span> crime_nn3 <span class="sc">+</span> </span>
<span id="cb113-19"><a href="#cb113-19" aria-hidden="true" tabindex="-1"></a>              <span class="fu">as.factor</span>(name),</span>
<span id="cb113-20"><a href="#cb113-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> boston.sf, <span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">trControl =</span> ctrl</span>
<span id="cb113-21"><a href="#cb113-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb113-22"><a href="#cb113-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-23"><a href="#cb113-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare</span></span>
<span id="cb113-24"><a href="#cb113-24" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(</span>
<span id="cb113-25"><a href="#cb113-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">Model =</span> <span class="fu">c</span>(<span class="st">"Structural"</span>, <span class="st">"Spatial"</span>, <span class="st">"Fixed Effects"</span>),</span>
<span id="cb113-26"><a href="#cb113-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">RMSE =</span> <span class="fu">c</span>(cv_m1<span class="sc">$</span>results<span class="sc">$</span>RMSE, cv_m2<span class="sc">$</span>results<span class="sc">$</span>RMSE, cv_m3<span class="sc">$</span>results<span class="sc">$</span>RMSE)</span>
<span id="cb113-27"><a href="#cb113-27" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<hr>
</section>
<section id="the-problem-sparse-categories" class="level2">
<h2 class="anchored" data-anchor-id="the-problem-sparse-categories">⚠️ The Problem: Sparse Categories</h2>
<section id="when-cv-fails-with-categorical-variables" class="level3">
<h3 class="anchored" data-anchor-id="when-cv-fails-with-categorical-variables">When CV Fails with Categorical Variables</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co"># You might see this error:</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>Error <span class="cf">in</span> model.frame.default<span class="sc">:</span> </span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>  factor <span class="st">'name'</span> has new level <span class="st">'West End'</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p><strong>What happened?</strong></p>
<ol type="1">
<li>Random split created 10 folds</li>
<li>All “West End” sales ended up in ONE fold (the test fold)</li>
<li>Training folds never saw “West End”</li>
<li>Model can’t predict for a category it never learned</li>
</ol>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>The Issue
</div>
</div>
<div class="callout-body-container callout-body">
<p>When neighborhoods have <strong>very few sales</strong> (&lt;10), random CV splits can put all instances in the same fold, breaking the model.</p>
</div>
</div>
<hr>
</section>
</section>
<section id="check-your-data-first" class="level2">
<h2 class="anchored" data-anchor-id="check-your-data-first">Check Your Data First!</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ALWAYS run this before CV with categorical variables</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>category_check %</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(name) <span class="sc">%&gt;%</span></span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(n)</span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(category_check)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p><strong>Typical output:</strong></p>
<pre><code>name                n
West End            3  ⚠️ Problem!
Bay Village         5  ⚠️ Risky
Leather District    8  ⚠️ Borderline
Back Bay           89  ✓ Safe
South Boston      112  ✓ Safe</code></pre>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Rule of Thumb:</strong> Categories with <strong>n &lt; 10</strong> will likely cause CV problems</p>
</div>
</div>
<hr>
</section>
<section id="solution-group-small-neighborhoods" class="level2">
<h2 class="anchored" data-anchor-id="solution-group-small-neighborhoods">Solution: Group Small Neighborhoods</h2>
<p><strong>Most practical approach:</strong></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Add count column</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>boston.sf <span class="ot">&lt;-</span> boston.sf <span class="sc">%&gt;%</span></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_count</span>(name)</span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Group small neighborhoods</span></span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>boston.sf <span class="ot">&lt;-</span> boston.sf <span class="sc">%&gt;%</span></span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">name_cv =</span> <span class="fu">if_else</span>(</span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a>      n <span class="sc">&lt;</span> <span class="dv">10</span>,                       <span class="co"># If fewer than 10 sales</span></span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">"Small_Neighborhoods"</span>,        <span class="co"># Group them</span></span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.character</span>(name)            <span class="co"># Keep original</span></span>
<span id="cb117-12"><a href="#cb117-12" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb117-13"><a href="#cb117-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">name_cv =</span> <span class="fu">as.factor</span>(name_cv)</span>
<span id="cb117-14"><a href="#cb117-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb117-15"><a href="#cb117-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-16"><a href="#cb117-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Use grouped version in CV</span></span>
<span id="cb117-17"><a href="#cb117-17" aria-hidden="true" tabindex="-1"></a>cv_model_fe <span class="ot">&lt;-</span> <span class="fu">train</span>(</span>
<span id="cb117-18"><a href="#cb117-18" aria-hidden="true" tabindex="-1"></a>  SalePrice <span class="sc">~</span> LivingArea <span class="sc">+</span> Age <span class="sc">+</span> crimes_500ft <span class="sc">+</span> </span>
<span id="cb117-19"><a href="#cb117-19" aria-hidden="true" tabindex="-1"></a>              <span class="fu">as.factor</span>(name_cv),   <span class="co"># Use name_cv, not name!</span></span>
<span id="cb117-20"><a href="#cb117-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> boston.sf,</span>
<span id="cb117-21"><a href="#cb117-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"lm"</span>,</span>
<span id="cb117-22"><a href="#cb117-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">trControl =</span> <span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">"cv"</span>, <span class="at">number =</span> <span class="dv">10</span>)</span>
<span id="cb117-23"><a href="#cb117-23" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p><strong>Trade-off:</strong> Lose granularity for small neighborhoods, but avoid CV crashes</p>
<hr>
</section>
<section id="alternative-drop-sparse-categories" class="level2">
<h2 class="anchored" data-anchor-id="alternative-drop-sparse-categories">Alternative: Drop Sparse Categories</h2>
<p><strong>If grouping doesn’t make sense:</strong></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove neighborhoods with &lt; 10 sales</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>neighborhood_counts %</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(name)</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>keep_neighborhoods %</span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n <span class="sc">&gt;=</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(name)</span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a>boston_filtered %</span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(name <span class="sc">%in%</span> keep_neighborhoods)</span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Removed"</span>, <span class="fu">nrow</span>(boston.sf) <span class="sc">-</span> <span class="fu">nrow</span>(boston_filtered), <span class="st">"observations"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Consider carefully:</strong> Which neighborhoods are you excluding? Often those with less data are marginalized communities. Document what you removed and why.</p>
</div>
</div>
<hr>
</section>
<section id="my-recommended-workflow" class="level2">
<h2 class="anchored" data-anchor-id="my-recommended-workflow">My Recommended Workflow</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Check category sizes</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>boston.sf <span class="sc">%&gt;%</span></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(name) <span class="sc">%&gt;%</span></span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(n) <span class="sc">%&gt;%</span></span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 19 × 2
   name              n
   &lt;chr&gt;         &lt;int&gt;
 1 Bay Village       1
 2 Downtown          1
 3 Fenway            2
 4 Back Bay          3
 5 Allston           6
 6 Brighton          6
 7 Mission Hill     14
 8 Beacon Hill      17
 9 South End        20
10 Roxbury          63
11 Charlestown      65
12 Mattapan         65
13 South Boston     80
14 Jamaica Plain   113
15 Roslindale      142
16 East Boston     149
17 Hyde Park       152
18 West Roxbury    242
19 Dorchester      344</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Group if needed</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>boston.sf <span class="ot">&lt;-</span> boston.sf <span class="sc">%&gt;%</span></span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_count</span>(name) <span class="sc">%&gt;%</span></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">name_cv =</span> <span class="fu">if_else</span>(n <span class="sc">&lt;</span> <span class="dv">10</span>, <span class="st">"Small_Neighborhoods"</span>, <span class="fu">as.character</span>(name)),</span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">name_cv =</span> <span class="fu">as.factor</span>(name_cv)</span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Set up CV</span></span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a>ctrl <span class="ot">&lt;-</span> <span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">"cv"</span>, <span class="at">number =</span> <span class="dv">10</span>)</span>
<span id="cb121-11"><a href="#cb121-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-12"><a href="#cb121-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Use grouped neighborhoods in ALL models with FE</span></span>
<span id="cb121-13"><a href="#cb121-13" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">train</span>(</span>
<span id="cb121-14"><a href="#cb121-14" aria-hidden="true" tabindex="-1"></a>  SalePrice <span class="sc">~</span> LivingArea <span class="sc">+</span> Age <span class="sc">+</span> crimes_500ft <span class="sc">+</span> <span class="fu">as.factor</span>(name_cv),</span>
<span id="cb121-15"><a href="#cb121-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> boston.sf,</span>
<span id="cb121-16"><a href="#cb121-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"lm"</span>,</span>
<span id="cb121-17"><a href="#cb121-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">trControl =</span> ctrl</span>
<span id="cb121-18"><a href="#cb121-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb121-19"><a href="#cb121-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-20"><a href="#cb121-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Report</span></span>
<span id="cb121-21"><a href="#cb121-21" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"10-fold CV RMSE:"</span>, <span class="fu">round</span>(model<span class="sc">$</span>results<span class="sc">$</span>RMSE, <span class="dv">0</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>10-fold CV RMSE: 355347 </code></pre>
</div>
</div>
<hr>
</section>
<section id="full-model-comparison-with-cv" class="level2">
<h2 class="anchored" data-anchor-id="full-model-comparison-with-cv">Full Model Comparison with CV</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Prep data</span></span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>boston.sf <span class="ot">&lt;-</span> boston.sf <span class="sc">%&gt;%</span></span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_count</span>(name) <span class="sc">%&gt;%</span></span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name_cv =</span> <span class="fu">if_else</span>(n <span class="sc">&lt;</span> <span class="dv">10</span>, <span class="st">"Small_Neighborhoods"</span>, <span class="fu">as.character</span>(name)),</span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">name_cv =</span> <span class="fu">as.factor</span>(name_cv))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Storing counts in `nn`, as `n` already present in input
ℹ Use `name = "new_name"` to pick a new name.</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>ctrl <span class="ot">&lt;-</span> <span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">"cv"</span>, <span class="at">number =</span> <span class="dv">10</span>)</span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare models</span></span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>cv_structural <span class="ot">&lt;-</span> <span class="fu">train</span>(</span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>  SalePrice <span class="sc">~</span> LivingArea <span class="sc">+</span> Age <span class="sc">+</span> R_FULL_BTH,</span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> boston.sf, <span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">trControl =</span> ctrl</span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a>cv_spatial <span class="ot">&lt;-</span> <span class="fu">train</span>(</span>
<span id="cb125-10"><a href="#cb125-10" aria-hidden="true" tabindex="-1"></a>  SalePrice <span class="sc">~</span> LivingArea <span class="sc">+</span> Age <span class="sc">+</span> R_FULL_BTH <span class="sc">+</span> crimes_500ft <span class="sc">+</span> crime_nn3,</span>
<span id="cb125-11"><a href="#cb125-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> boston.sf, <span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">trControl =</span> ctrl</span>
<span id="cb125-12"><a href="#cb125-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb125-13"><a href="#cb125-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-14"><a href="#cb125-14" aria-hidden="true" tabindex="-1"></a>cv_fixedeffects <span class="ot">&lt;-</span> <span class="fu">train</span>(</span>
<span id="cb125-15"><a href="#cb125-15" aria-hidden="true" tabindex="-1"></a>  SalePrice <span class="sc">~</span> LivingArea <span class="sc">+</span> Age <span class="sc">+</span> R_FULL_BTH <span class="sc">+</span> crimes_500ft <span class="sc">+</span> crime_nn3 <span class="sc">+</span> </span>
<span id="cb125-16"><a href="#cb125-16" aria-hidden="true" tabindex="-1"></a>              <span class="fu">as.factor</span>(name_cv),</span>
<span id="cb125-17"><a href="#cb125-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> boston.sf, <span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">trControl =</span> ctrl</span>
<span id="cb125-18"><a href="#cb125-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb125-19"><a href="#cb125-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-20"><a href="#cb125-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Results</span></span>
<span id="cb125-21"><a href="#cb125-21" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(</span>
<span id="cb125-22"><a href="#cb125-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">Model =</span> <span class="fu">c</span>(<span class="st">"Structural"</span>, <span class="st">"+ Spatial"</span>, <span class="st">"+ Fixed Effects"</span>),</span>
<span id="cb125-23"><a href="#cb125-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">RMSE =</span> <span class="fu">c</span>(cv_structural<span class="sc">$</span>results<span class="sc">$</span>RMSE, </span>
<span id="cb125-24"><a href="#cb125-24" aria-hidden="true" tabindex="-1"></a>           cv_spatial<span class="sc">$</span>results<span class="sc">$</span>RMSE, </span>
<span id="cb125-25"><a href="#cb125-25" aria-hidden="true" tabindex="-1"></a>           cv_fixedeffects<span class="sc">$</span>results<span class="sc">$</span>RMSE)</span>
<span id="cb125-26"><a href="#cb125-26" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>            Model     RMSE
1      Structural 535132.8
2       + Spatial 508962.7
3 + Fixed Effects 348169.2</code></pre>
</div>
</div>
<hr>
</section>
<section id="expected-results" class="level2">
<h2 class="anchored" data-anchor-id="expected-results">Expected Results</h2>
<p><strong>Typical pattern:</strong></p>
<pre><code>Model              RMSE      Interpretation
Structural        $533,330.60   Baseline - just house characteristics
+ Spatial         $500,421.5    Adding location features helps!
+ Fixed Effects   $347,261.30   Neighborhoods capture a LOT</code></pre>
<p><em>Note: these values are kind of ginormous - remember RMSE squares big errors, so outliers can have a really large impact</em></p>
<p><strong>Key Insight:</strong> Each layer improves <strong>out-of-sample</strong> prediction, with fixed effects providing the biggest boost</p>
<p><strong>Why?</strong> Neighborhoods bundle many unmeasured factors (schools, amenities, prestige) that we can’t easily quantify individually</p>
<hr>
</section>
<section id="investigating-those-errors" class="level2">
<h2 class="anchored" data-anchor-id="investigating-those-errors">Investigating those errors…</h2>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week-06-class-lab_files/figure-html/unnamed-chunk-52-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
       0   417500   519000   647981   650000 11600000 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 3
   SalePrice LivingArea name       
       &lt;dbl&gt;      &lt;dbl&gt; &lt;chr&gt;      
 1  11600000       9908 Back Bay   
 2   9500000       5283 Back Bay   
 3   6350000       4765 Back Bay   
 4   4600000       3018 Beacon Hill
 5   4300000       3981 South End  
 6   4274500       5439 Beacon Hill
 7   4200000       4146 South End  
 8   3900000       4396 Beacon Hill
 9   3877500       3849 Beacon Hill
10   3810000       4449 Beacon Hill</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week-06-class-lab_files/figure-html/unnamed-chunk-52-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Look for:</strong> - Prices over $2-3 million (could be luxury condos or errors) - Prices near $0 (data errors) - Long right tail in histogram</p>
<hr>
</section>
</section>
<section id="what-to-do" class="level1">
<h1>What to Do?</h1>
<p><strong>Log Transform the skewed dependent variable</strong></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Interpreting Log Models
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>RMSE is now in <strong>log-dollars</strong> (hard to interpret)</li>
<li>To convert back: <code>exp(predictions)</code> gives actual dollars</li>
<li>Coefficients now represent <strong>percentage changes</strong>, not dollar changes</li>
<li>This is standard practice in hedonic modeling!</li>
</ul>
</div>
</div>
<section id="team-exercise-practice-what-weve-done-and-build-your-best-model" class="level2">
<h2 class="anchored" data-anchor-id="team-exercise-practice-what-weve-done-and-build-your-best-model">Team Exercise: Practice What We’ve Done and Build Your Best Model</h2>
<p><strong>Goal:</strong> Create a comprehensive hedonic model using ALL concepts from today (and last week)</p>
<p><strong>Requirements:</strong></p>
<ol type="1">
<li>Structural variables (including categorical)</li>
<li>Spatial features (create your own - nhttps://data.boston.gov/group/geospatial</li>
<li>At least one interaction term</li>
<li>One non-linear (polynomial term)</li>
<li>Neighborhood fixed effects (handle sparse categories!)</li>
<li>10-fold cross-validation</li>
<li>Report final RMSE</li>
</ol>
</section>
<section id="use-diagnostics-from-last-week-as-you-build" class="level2">
<h2 class="anchored" data-anchor-id="use-diagnostics-from-last-week-as-you-build"><em>Use diagnostics from last week as you build!</em></h2>
</section>
<section id="report-out-on-board" class="level2">
<h2 class="anchored" data-anchor-id="report-out-on-board">Report Out on Board</h2>
<p><strong>Each team will share (3 minutes):</strong></p>
<ol type="1">
<li><p><strong>Variables used:</strong></p>
<ul>
<li>Structural: ____________</li>
<li>Spatial: ____________</li>
<li>Non-linear: __________</li>
<li>Interactions: ____________</li>
<li>Fixed Effects: Yes/No, how handled sparse categories?</li>
</ul></li>
<li><p><strong>Final cross-validated RMSE:</strong> $____________ and <strong>MAE</strong> $______________</p></li>
<li><p><strong>One insight:</strong></p>
<ul>
<li>What made the biggest difference?</li>
<li>Did anything surprise you?</li>
<li>Which variables mattered most?</li>
</ul></li>
</ol>
<hr>
</section>
<section id="tips-for-success" class="level2">
<h2 class="anchored" data-anchor-id="tips-for-success">Tips for Success</h2>
<div class="columns">
<div class="column" style="width:50%;">
<section id="do" class="level3">
<h3 class="anchored" data-anchor-id="do">✅ Do:</h3>
<ul>
<li>Start simple, add complexity</li>
<li>Check for NAs: <code>sum(is.na())</code></li>
<li>Test on small subset first</li>
<li>Comment your code</li>
<li>Check coefficient signs</li>
<li>Use <code>glimpse()</code>, <code>summary()</code></li>
</ul>
</section>
<section id="dont" class="level3">
<h3 class="anchored" data-anchor-id="dont">❌ Don’t:</h3>
<ul>
<li>Add 50 variables at once</li>
<li>Ignore errors</li>
<li>Forget <code>st_drop_geometry()</code> for non-spatial operations</li>
<li>Skip sparse category check</li>
</ul>
</section>
</div><div class="column" style="width:50%;">
<section id="common-errors" class="level3">
<h3 class="anchored" data-anchor-id="common-errors">Common Errors</h3>
<p><strong>“Factor has new levels”</strong> → Group sparse categories</p>
<p><strong>“Computationally singular”</strong> → Remove collinear variables</p>
<p><strong>Very high RMSE</strong> → Check outliers, scale</p>
<p><strong>CV takes forever</strong> → Simplify model or reduce folds</p>
<p><strong>Negative R²</strong> → Model worse than mean, rethink variables</p>
</section>
</div>
</div>
<hr>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>