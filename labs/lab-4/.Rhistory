legend.key.height = unit(0.5, "cm")
)
}
theme_chi_plot <- function(base_size = 11) {
theme_minimal(base_size = base_size) +
theme(
plot.title = element_text(face = "bold",
size = base_size + 1,
hjust = 0.5
),
plot.subtitle = element_text(face = "italic",
color = "gray30",
size = base_size - 1,
hjust = 0.5
),
legend.position = "bottom",
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.text = element_text(face = "italic",
size = base_size - 3,
hjust = 0.5
),
axis.title = element_text(face = "italic",
size = base_size - 3,
hjust = 0.5
),
legend.title = element_text(face = "italic",
size = base_size - 1,
hjust = 0.5
),
legend.title.position = "top",
legend.text = element_text(face = "italic",
size = base_size - 3,
hjust = 0.5
),
legend.key.width = unit(2, "cm"),
legend.key.height = unit(0.5, "cm")
)
}
#| message: false
#| warning: false
#| include: false
# Load Chicago's boundaries.
chicago_boundary <-
st_read("data/chicago_boundary.geojson") %>%
st_transform("ESRI:102271")
# Load census block groups.
#cook_county <-
#  st_read("data/block_groups_2010/block_groups_2010.shp") %>%
#  st_transform("ESRI:102271") %>%
#  filter(str_detect(COUNTYFP, "031"))
# Clip Cook County block groups with Chicago's boundaries.
#block_groups <-
#  cook_county %>%
#  st_intersection(st_transform(chicago_boundary, "ESRI:102271"))
# Load Chicago's police districts.
police_districts <-
st_read("data/police_districts.geojson") %>%
st_transform("ESRI:102271")
# Load Chicago's neighborhood boundaries.
neighborhoods <-
st_read("data/neighborhoods.geojson") %>%
st_transform("ESRI:102271")
# Load Chicago's major streets.
streets <-
st_read("data/major_streets/major_streets.shp") %>%
st_transform("ESRI:102271")
# Load Chicago's building footprints.
url_buildings <- "https://data.cityofchicago.org/resource/syp8-uezg.geojson"
# Create query filter.
query_buildings <-
"?$where=year_built <= 2017 AND (bldg_end_d IS NULL OR bldg_end_d >= '2017-01-01T00:00:00')&$limit=500000"
# Combine URL and query.
full_buildings <- paste0(url_buildings, query_buildings)
# Load filtered data.
buildings <-
st_read(full_buildings) %>%
st_transform("ESRI:102271")
# Create query filter.
query_buildings <-
"?$where=year_built <= 2017 AND (bldg_end_d IS NULL OR bldg_end_d >= '2017-01-01T24:00:00')&$limit=500000"
# Combine URL and query.
full_buildings <- paste0(url_buildings, query_buildings)
# Load filtered data.
buildings <-
st_read(full_buildings) %>%
st_transform("ESRI:102271")
# Load Chicago's building footprints.
url_buildings <- "https://data.cityofchicago.org/resource/syp8-uezg.geojson"
# Create query filter.
query_buildings <-
"?$where=year_built <= 2017 AND (bldg_end_d IS NULL OR bldg_end_d >= '2017-01-01')&$limit=500000"
# Combine URL and query.
full_buildings <- paste0(url_buildings, query_buildings)
# Load filtered data.
buildings <-
st_read(full_buildings) %>%
st_transform("ESRI:102271")
# Create query filter.
query_buildings <-
"?$where=year_built <= 2017 AND (bldg_end_d IS NULL OR bldg_end_d >= '2017-01-01T00:00:00')&$limit=500000"
# Combine URL and query.
full_buildings <- paste0(url_buildings, query_buildings)
# Load filtered data.
buildings <-
st_read(full_buildings) %>%
st_transform("ESRI:102271")
library(RSocrata)       # API querying.
#| message: false
#| warning: false
#| include: false
install.packages(RSocrata)
#| message: false
#| warning: false
#| include: false
install.packages("RSocrata")
#| message: false
#| warning: false
#| include: false
install.packages(httr)
#| message: false
#| warning: false
#| include: false
install.packages("httr")
#| message: false
#| warning: false
#| include: false
# Load relevant packages.
library(tidyverse)      # Data manipulation.
library(dplyr)          # Data manipulation.
library(stringr)        # Data manipulation.
library(sf)             # Spatial operations.
library(here)           # Relative file paths.
library(viridis)        # Color scales.
library(terra)          # Raster operations (replaces "raster").
library(spdep)          # Spatial dependence.
library(FNN)            # Fast nearest neighbors.
library(MASS)           # Negative binomial regression.
library(patchwork)      # Plot composition (replaces grid/gridExtra).
library(knitr)          # Tables.
library(kableExtra)     # Table formatting.
library(classInt)       # Classification intervals.
library(ggplot2)        # Plotting.
library(kableExtra)     # Professional tables.
library(car)            # Use VIF.
library(httr)       # API querying.
# Spatstat split into sub-packages.
library(spatstat.geom)    # Spatial geometries.
library(spatstat.explore) # Spatial exploration/KDE.
# Set options.
options(scipen = 999)  # No scientific notation.
set.seed(5080)         # Reproducibility.
# Create consistent themes for visualizations.
theme_chi_map <- function(base_size = 11) {
theme_minimal(base_size = base_size) +
theme(
plot.title = element_text(face = "bold",
size = base_size + 1,
hjust = 0.5
),
plot.subtitle = element_text(face = "italic",
color = "gray30",
size = base_size - 1,
hjust = 0.5
),
legend.position = "bottom",
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.text = element_blank(),
axis.title = element_blank(),
legend.title = element_text(face = "italic",
size = base_size - 1,
hjust = 0.5
),
legend.title.position = "top",
legend.text = element_text(face = "italic",
size = base_size - 3,
hjust = 0.5
),
legend.key.width = unit(2, "cm"),
legend.key.height = unit(0.5, "cm")
)
}
theme_chi_plot <- function(base_size = 11) {
theme_minimal(base_size = base_size) +
theme(
plot.title = element_text(face = "bold",
size = base_size + 1,
hjust = 0.5
),
plot.subtitle = element_text(face = "italic",
color = "gray30",
size = base_size - 1,
hjust = 0.5
),
legend.position = "bottom",
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.text = element_text(face = "italic",
size = base_size - 3,
hjust = 0.5
),
axis.title = element_text(face = "italic",
size = base_size - 3,
hjust = 0.5
),
legend.title = element_text(face = "italic",
size = base_size - 1,
hjust = 0.5
),
legend.title.position = "top",
legend.text = element_text(face = "italic",
size = base_size - 3,
hjust = 0.5
),
legend.key.width = unit(2, "cm"),
legend.key.height = unit(0.5, "cm")
)
}
# Load Chicago's building footprints.
# 1. Define the base URL and the "where" filter separately
base_url <- "https://data.cityofchicago.org/resource/syp8-uezg.geojson"
# This is your SODA query filter
# We use URLencode() to safely handle spaces and special characters
where_filter <- URLencode("year_built <= 2017 AND (bldg_end_d IS NULL OR bldg_end_d >= '2017-01-01T00:00:00')")
# 2. Build the full, safe URL
# We also add a high limit
full_url <- paste0(
base_url,
"?$where=", where_filter,
"&$limit=500000" # Make sure limit is high enough
)
cat("Downloading building footprints for 2017 snapshot...\n")
cat("This may take several minutes as it's a large query.\n")
# 3. Use httr::GET() to download the data
response <- GET(full_url)
# 3. Use httr::GET() to download the data
response <- GET(full_url)
# 4. Check for errors (like 404, 500, etc.)
stop_for_status(response)
# 5. Read the content as text, then use st_read() on the text
# This is the key step: we read the downloaded text, not the URL
cat("Download complete. Parsing GeoJSON text...\n")
buildings <- st_read(content(response, as = "text"), quiet = TRUE) %>%
st_transform("ESRI:102Write") # Project to match your other data
#| message: false
#| warning: false
#| include: false
# Load relevant packages.
library(tidyverse)      # Data manipulation.
library(dplyr)          # Data manipulation.
library(stringr)        # Data manipulation.
library(sf)             # Spatial operations.
library(here)           # Relative file paths.
library(viridis)        # Color scales.
library(terra)          # Raster operations (replaces "raster").
library(spdep)          # Spatial dependence.
library(FNN)            # Fast nearest neighbors.
library(MASS)           # Negative binomial regression.
library(patchwork)      # Plot composition (replaces grid/gridExtra).
library(knitr)          # Tables.
library(kableExtra)     # Table formatting.
library(classInt)       # Classification intervals.
library(ggplot2)        # Plotting.
library(kableExtra)     # Professional tables.
library(car)            # Use VIF.
library(httr)       # API querying.
# Spatstat split into sub-packages.
library(spatstat.geom)    # Spatial geometries.
library(spatstat.explore) # Spatial exploration/KDE.
# Set options.
options(scipen = 999)  # No scientific notation.
set.seed(5080)         # Reproducibility.
# Create consistent themes for visualizations.
theme_chi_map <- function(base_size = 11) {
theme_minimal(base_size = base_size) +
theme(
plot.title = element_text(face = "bold",
size = base_size + 1,
hjust = 0.5
),
plot.subtitle = element_text(face = "italic",
color = "gray30",
size = base_size - 1,
hjust = 0.5
),
legend.position = "bottom",
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.text = element_blank(),
axis.title = element_blank(),
legend.title = element_text(face = "italic",
size = base_size - 1,
hjust = 0.5
),
legend.title.position = "top",
legend.text = element_text(face = "italic",
size = base_size - 3,
hjust = 0.5
),
legend.key.width = unit(2, "cm"),
legend.key.height = unit(0.5, "cm")
)
}
theme_chi_plot <- function(base_size = 11) {
theme_minimal(base_size = base_size) +
theme(
plot.title = element_text(face = "bold",
size = base_size + 1,
hjust = 0.5
),
plot.subtitle = element_text(face = "italic",
color = "gray30",
size = base_size - 1,
hjust = 0.5
),
legend.position = "bottom",
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.text = element_text(face = "italic",
size = base_size - 3,
hjust = 0.5
),
axis.title = element_text(face = "italic",
size = base_size - 3,
hjust = 0.5
),
legend.title = element_text(face = "italic",
size = base_size - 1,
hjust = 0.5
),
legend.title.position = "top",
legend.text = element_text(face = "italic",
size = base_size - 3,
hjust = 0.5
),
legend.key.width = unit(2, "cm"),
legend.key.height = unit(0.5, "cm")
)
}
#| message: false
#| warning: false
#| include: false
# Load Chicago's boundaries.
chicago_boundary <-
st_read("data/chicago_boundary.geojson") %>%
st_transform("ESRI:102271")
# Load census block groups.
#cook_county <-
#  st_read("data/block_groups_2010/block_groups_2010.shp") %>%
#  st_transform("ESRI:102271") %>%
#  filter(str_detect(COUNTYFP, "031"))
# Clip Cook County block groups with Chicago's boundaries.
#block_groups <-
#  cook_county %>%
#  st_intersection(st_transform(chicago_boundary, "ESRI:102271"))
# Load Chicago's police districts.
police_districts <-
st_read("data/police_districts.geojson") %>%
st_transform("ESRI:102271")
# Load Chicago's neighborhood boundaries.
neighborhoods <-
st_read("data/neighborhoods.geojson") %>%
st_transform("ESRI:102271")
# Load Chicago's major streets.
streets <-
st_read("data/major_streets/major_streets.shp") %>%
st_transform("ESRI:102271")
# Load Chicago's building footprints.
# 1. Define the base URL and the "where" filter separately
base_url <- "https://data.cityofchicago.org/resource/syp8-uezg.geojson"
# This is your SODA query filter
where_filter <- URLencode("year_built <= 2017 AND (bldg_end_d IS NULL OR bldg_end_d >= '2017-01-01T00:00:00')")
# 2. Build the full, safe URL
full_url <- paste0(
base_url,
"?$where=", where_filter,
"&$limit=500000" # Make sure limit is high enough
)
cat("Downloading building footprints for 2017 snapshot...\n")
cat("This may take several minutes as it's a large query.\n")
# 3. Use httr::GET() to download the data
response <- GET(full_url)
# 4. Check for errors (like 404, 500, etc.)
stop_for_status(response)
# 5. Read the content as text, then use st_read() on the text
cat("Download complete. Parsing GeoJSON text...\n")
buildings <- st_read(content(response, as = "text"), quiet = TRUE) %>%
st_set_crs(4326) %>% # Set initial CRS as WGS84 (standard for GeoJSON)
# --- THIS IS THE FIX ---
st_transform("ESRI:102271") # Transform to Illinois State Plane
cat("âœ“ Successfully loaded and projected", nrow(buildings), "buildings.\n")
# 6. Clean up any potential invalid geometries
buildings <- buildings %>% st_buffer(0)
View(buildings)
base_url <- "https://data.cityofchicago.org/resource/syp8-uezg.geojson"
# Query filter. Year built before or in year 2017 and building activity is NULL or within 2017.
where_filter <- URLencode("year_built <= 2017 AND (bldg_end_d IS NULL OR bldg_end_d >= '2017-01-01T00:00:00')")
# Combine for full URL.
full_url <- paste0(
base_url,
"?$where=", where_filter,
"&$limit=1000000" # Make limit very high because it is a big dataset.
)
# Download data using httr library's GET function.
response <- GET(full_url)
# Check for errors.
stop_for_status(response)
# Read the content as text, then use st_read() on the text
buildings <- st_read(content(response, as = "text"), quiet = TRUE) %>%
st_set_crs(4326) %>% # Set CRS.
st_transform("ESRI:102271") # Transform CRS.
#| message: false
#| warning: false
#| include: false
# Load 2017 burglary data.
burglaries <-
st_read("data/burglaries_2017.geojson") %>%
st_transform("ESRI:102271")
# Load 2018 burglary data.
burglaries_2018 <-
st_read("data/burglaries_2018.geojson") %>%
st_transform("ESRI:102271")
#| message: false
#| warning: false
#| include: false
# Load 2017 311 data for single street light outage.
light_outage <-
st_read("data/single_light_outage_2017.geojson") %>%
st_transform("ESRI:102271")
#| message: false
#| warning: false
#| include: false
# Load vacant buildings data.
vacant <-
st_read("data/vacant_buildings.geojson") %>%
st_transform("ESRI:102271")
# Load CTA L station data.
station <-
st_read("data/L_stations.geojson") %>%
st_transform("ESRI:102271")
# Load zoning data.
zoning <-
st_read("data/zoning.geojson") %>%
st_transform("ESRI:102271")
# Clean zoning data.
# Put different zoning sub-classes into one overall class.
zoning <- zoning %>%
mutate(type = case_when(
# Downtown
str_starts(zone_class, "D") ~ "Downtown",
# Residential
str_starts(zone_class, "R")  ~ "Residential",
# Business/Commercial
str_starts(zone_class, "B|C") ~ "Business/Commercial",
# Industrial
str_starts(zone_class, "M") ~ "Industrial",
# Park/Open Space
str_starts(zone_class, "POS") ~ "Park/Open Space"
)
)
# Check counts.
table(zoning$type)
# Clean building data.
buildings <- buildings %>%
mutate(
# Calculate Age for 2017.
building_age = 2017 - year_built,
# Calculate area of each building.
building_area = st_area(.)
)
View(buildings)
#| message: false
#| warning: false
#| include: false
# Very large dataset with very long load time.
# Load Chicago's building footprints using API.
# Create base URL.
base_url <- "https://data.cityofchicago.org/resource/syp8-uezg.geojson"
# Query filter. Year built before or in year 2017 and building activity is NULL or within 2017.
where_filter <- URLencode(
paste(
"year_built <= 2017",
"AND year_built > 0",
"AND stories > 0",
"AND bldg_activ >= '1900-01-01T00:00:00'",
"AND (bldg_end_d IS NULL OR bldg_end_d >= '2017-01-01T00:00:00')"
)
)
# Combine for full URL.
full_url <- paste0(
base_url,
"?$where=", where_filter,
"&$limit=1000000" # Make limit very high because it is a big dataset.
)
# Download data using httr library's GET function.
response <- GET(full_url)
# Check for errors.
stop_for_status(response)
# Read the content as text, then use st_read() on the text
buildings <- st_read(content(response, as = "text"), quiet = TRUE) %>%
st_set_crs(4326) %>% # Set CRS.
st_transform("ESRI:102271") # Transform CRS.
View(buildings)
# Clean building data.
buildings <- buildings %>%
mutate(
# Calculate Age for 2017.
building_age = 2017 - year_built,
# Calculate area of each building.
building_area = st_area(.)
)
