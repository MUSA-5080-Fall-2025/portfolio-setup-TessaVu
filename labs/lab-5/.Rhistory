model3_q4 <- lm(
trips ~ as.factor(hour) + dow_simple + temp + precip +
lag_1hr + lag_3hr + lag_1day +
med_inc + pct_public_commute + pct_white,
data = train_clean
)
summary(model3_q4)
# Get metrics.
metrics3_q4 <- get_metrics(model3_q4, "Model 3 2024 Q4")
# Predict test set and calculate MAE.
test_clean$pred3 <- predict(model3_q4, newdata = test_clean)
mae_value <- mean(abs(test_clean$trips - test_clean$pred3), na.rm = TRUE)
# Add MAE to metrics table.
metrics3_q4 <- metrics3_q4 %>% mutate(mae = mae_value)
# Fit model.
model4_q4 <- lm(
trips ~ as.factor(hour) + dow_simple + temp + precip +
lag_1hr + lag_3hr + lag_1day +
med_inc + pct_public_commute + pct_white +
as.factor(start_station_id),
data = train_clean
)
# Summary too long with all station dummies, just show key metrics.
cat("Model 4 R-Squared:", summary(model4_q4)$r.squared, "\n")
cat("Model 4 Adjusted R-Squared:", summary(model4_q4)$adj.r.squared, "\n")
# Get metrics.
metrics4_q4 <- get_metrics(model4_q4, "Model 4 2024 Q4")
# Predict test set and calculate MAE.
test_clean$pred4 <- predict(model4_q4, newdata = test_clean)
mae_value <- mean(abs(test_clean$trips - test_clean$pred4), na.rm = TRUE)
# Add MAE to metrics table.
metrics4_q4 <- metrics4_q4 %>% mutate(mae = mae_value)
# Fit model.
model5_q4 <- lm(
trips ~ as.factor(hour) + dow_simple + temp + precip +
lag_1hr + lag_3hr + lag_1day +
med_inc + pct_public_commute + pct_white +
as.factor(start_station_id) +
rush_hour * is_weekend,
data = train_clean
)
# Summary too long with all station dummies, just show key metrics.
cat("Model 5 R-Squared:", summary(model5_q4)$r.squared, "\n")
cat("Model 5 Adjusted R-Squared:", summary(model5_q4)$adj.r.squared, "\n")
# Get metrics.
metrics5_q4 <- get_metrics(model5_q4, "Model 5 2024 Q4")
# Predict test set and calculate MAE.
test_clean$pred5 <- predict(model5_q4, newdata = test_clean)
mae_value <- mean(abs(test_clean$trips - test_clean$pred5), na.rm = TRUE)
# Add MAE to metrics table.
metrics5_q4 <- metrics5_q4 %>% mutate(mae = mae_value)
# Fit model.
model1_q1 <- lm(
trips ~ as.factor(hour) + dow_simple + temp + precip,
data = train_q1_clean
)
summary(model1_q1)
# Get metrics.
metrics1_q1 <- get_metrics(model1_q1, "Model 1 2025 Q1")
# Predict test set and calculate MAE.
test_q1_clean$pred1 <- predict(model1_q1, newdata = test_q1_clean)
mae_value <- mean(abs(test_q1_clean$trips - test_q1_clean$pred1), na.rm = TRUE)
# Add MAE to metrics table.
metrics1_q1 <- metrics1_q1 %>% mutate(mae = mae_value)
# Fit model.
model2_q1 <- lm(
trips ~ as.factor(hour) + dow_simple + temp + precip +
lag_1hr + lag_3hr + lag_1day,
data = train_q1_clean
)
summary(model2_q1)
# Get metrics.
metrics2_q1 <- get_metrics(model2_q1, "Model 2 2025 Q1")
# Predict test set and calculate MAE.
test_q1_clean$pred2 <- predict(model2_q1, newdata = test_q1_clean)
mae_value <- mean(abs(test_q1_clean$trips - test_q1_clean$pred2), na.rm = TRUE)
# Add MAE to metrics table.
metrics2_q1 <- metrics2_q1 %>% mutate(mae = mae_value)
# Fit model.
model3_q1 <- lm(
trips ~ as.factor(hour) + dow_simple + temp + precip +
lag_1hr + lag_3hr + lag_1day +
med_inc + pct_public_commute + pct_white,
data = train_q1_clean
)
summary(model3_q1)
# Get metrics.
metrics3_q1 <- get_metrics(model3_q1, "Model 3 2025 Q1")
# Predict test set and calculate MAE.
test_q1_clean$pred3 <- predict(model3_q1, newdata = test_q1_clean)
mae_value <- mean(abs(test_q1_clean$trips - test_q1_clean$pred3), na.rm = TRUE)
# Add MAE to metrics table.
metrics3_q1 <- metrics3_q1 %>% mutate(mae = mae_value)
# Fit model.
model4_q1 <- lm(
trips ~ as.factor(hour) + dow_simple + temp + precip +
lag_1hr + lag_3hr + lag_1day +
med_inc + pct_public_commute + pct_white +
as.factor(start_station_id),
data = train_q1_clean
)
# Summary too long with all station dummies, just show key metrics.
cat("Model 4 R-Squared:", summary(model4_q1)$r.squared, "\n")
cat("Model 4 Adjusted R-Squared:", summary(model4_q1)$adj.r.squared, "\n")
# Get metrics.
metrics4_q1 <- get_metrics(model4_q1, "Model 4 2025 Q1")
# Predict test set and calculate MAE.
test_q1_clean$pred4 <- predict(model4_q1, newdata = test_q1_clean)
mae_value <- mean(abs(test_q1_clean$trips - test_q1_clean$pred4), na.rm = TRUE)
# Add MAE to metrics table.
metrics4_q1 <- metrics4_q1 %>% mutate(mae = mae_value)
# Fit model.
model5_q1 <- lm(
trips ~ as.factor(hour) + dow_simple + temp + precip +
lag_1hr + lag_3hr + lag_1day +
med_inc + pct_public_commute + pct_white +
as.factor(start_station_id) +
rush_hour * is_weekend,
data = train_q1_clean
)
# Summary too long with all station dummies, just show key metrics.
cat("Model 5 R-Squared:", summary(model5_q1)$r.squared, "\n")
cat("Model 5 Adjusted R-Squared:", summary(model5_q1)$adj.r.squared, "\n")
# Get metrics.
metrics5_q1 <- get_metrics(model5_q1, "Model 5 2025 Q1")
# Predict test set and calculate MAE.
test_q1_clean$pred5 <- predict(model5_q1, newdata = test_q1_clean)
mae_value <- mean(abs(test_q1_clean$trips - test_q1_clean$pred5), na.rm = TRUE)
# Add MAE to metrics table.
metrics5_q1 <- metrics5_q1 %>% mutate(mae = mae_value)
# Combine all model metrics into single table.
final_metrics <- bind_rows(
metrics1_q4, metrics2_q4, metrics3_q4, metrics4_q4, metrics5_q4,
metrics1_q1, metrics2_q1, metrics3_q1, metrics4_q1, metrics5_q1
)
# Sort by MAE ascending.
final_metrics <- final_metrics %>%
arrange(mae)
# Create formatted table.
table_final <- final_metrics %>%
mutate(
# Round metrics for.
adjusted_r_squared = round(adjusted_r_squared, 4),
aic = scales::comma(round(aic, 0)),
mae = round(mae, 4)
) %>%
select(model, mae, adjusted_r_squared, aic) %>%
kable(
caption = "Model Performance Comparison (2024 Q4 vs. 2025 Q1)",
col.names = c("Model and Features", "MAE (Trips / 30-Min)", "Adjusted RÂ²", "AIC"),
align = c("l", "c", "c", "c", "c")
) %>%
kable_styling(
bootstrap_options = c("striped", "hover", "condensed"),
full_width = FALSE
) %>%
footnote(
general = "Average predicted trip count error per station-hour.\nSorted ascending.",
general_title = "MAE (Mean Absolute Error): Lower is better.",
footnote_as_chunk = FALSE
)
table_final
#| fig-dpi: 300
#| fig-height: 6
#| fig-width: 10
# Prepare data for MAE comparison plot.
mae_plot_data <- final_metrics %>%
mutate(
# Create readable model labels for x-axis.
model_label = case_when(
grepl("Model 1", model) ~ "1. Time / Weather",
grepl("Model 2", model) ~ "2. + Lags",
grepl("Model 3", model) ~ "3. + Demographics",
grepl("Model 4", model) ~ "4. + Station FE",
grepl("Model 5", model) ~ "5. + Interaction"
),
# Extract quarter for faceting.
forecast_type = ifelse(
grepl("2024 Q4", model),
"2024 Q4",
"2025 Q1"
)
)
# Create bar plot comparing MAE across models.
mae_comp_plot <- ggplot(mae_plot_data, aes(
# Order bars by MAE value.
x = reorder(model_label, -mae),
y = mae,
fill = forecast_type
)) +
# Create bars with border.
geom_col(alpha = 1,
colour = "#3d3b3c",
linewidth = 1) +
# Add value labels on top of bars.
geom_text(
aes(label = round(mae, 3)),
vjust = -0.3,
size = 18,
color = "#2d2a26",
family = "anonymous"
) +
# Separate facets for Q4 and Q1.
facet_wrap(~ forecast_type, scales = "free_x", ncol = 2) +
# Define colors for quarters.
scale_fill_manual(values = c(
"2024 Q4" = "#f6a2a7",
"2025 Q1" = "#8bcef2"
)) +
# Format y-axis.
scale_y_continuous(labels = scales::number_format(accuracy = 0.001)) +
labs(
title = "Model Prediction Accuracy Comparison",
subtitle = "Mean Absolute Error (MAE): 2024 Q4 (2024 Q4) vs. 2025 Q1 models",
x = "Model Complexity",
y = "Mean Absolute Error (Trips per 30-Min)",
fill = NULL
) +
theme_plot() +
theme(
# Angle x-axis labels.
axis.text.x = element_text(angle = 45, hjust = 1, size = 20),
# Hide legend since colors labeled in facets.
legend.position = "none",
# Format facet labels.
strip.text = element_text(
face = "bold",
size = 20,
family = "outfit",
color = "#2d2a26"
)
)
mae_comp_plot
#| message: false
#| warning: false
#| fig-dpi: 300
#| fig-height: 12
#| fig-width: 12
# Prepare test set for predictions.
# Create factor variable with proper contrasts.
test_clean <- test_clean %>%
mutate(dow_simple = factor(dow, levels = c("Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun")))
# Set treatment contrasts for factor.
contrasts(test_clean$dow_simple) <- contr.treatment(7)
# Generate predictions using Model 2.
test_clean <- test_clean %>%
mutate(
model2_q4_pred = predict(model2_q4, newdata = test_clean)
)
# Calculate error metrics.
test_q4_error <- test_clean %>%
mutate(
# Raw error (actual - predicted).
error = trips - model2_q4_pred,
# Absolute error for MAE calculation.
abs_error = abs(error),
# Categorize hour into time periods.
time_of_day = case_when(
hour < 7 ~ "Overnight", # 00:00 to 06:59
hour >= 7 & hour < 10 ~ "AM Rush", # 07:00 to 09:59
hour >= 10 & hour < 15 ~ "Mid-Day", # 10:00 to 14:59
hour >= 15 & hour <= 18 ~ "PM Rush", # 15:00 to 18:59
hour > 18 ~ "Evening" # 19:00 to 23:59
)
)
# Aggregate errors to station level.
station_errors_q4 <- test_q4_error %>%
group_by(start_station_id, start_lat, start_lon) %>%
summarize(
MAE = mean(abs_error, na.rm = TRUE),
# Average demand per station.
avg_demand = mean(trips, na.rm = TRUE),
.groups = "drop"
) %>%
# Remove stations with missing coordinates.
filter(!is.na(start_lat), !is.na(start_lon))
# Map of prediction errors.
pred_error_q4_map <- ggplot() +
# Census tracts as background.
geom_sf(data = philly_census, fill = "#2d2a26", color = "#ff4100", linewidth = 0.35) +
# Stations colored by MAE.
geom_point(
data = station_errors_q4,
aes(x = start_lon, y = start_lat, color = MAE),
size = 2,
alpha = 0.75
) +
scale_color_viridis(
option = "mako",
name = "MAE (Trips)",
direction = -1
) +
labs(
title = "Model Prediction Errors",
subtitle = "MAE per Station (Q4 2024 Test Set)"
) +
theme_map()
# Create map of average demand.
avg_dem_q4_map <- ggplot() +
geom_sf(data = philly_census, fill = "#2d2a26", color = "#ff4100", linewidth = 0.35) +
geom_point(
data = station_errors_q4,
aes(x = start_lon, y = start_lat, color = avg_demand),
size = 2,
alpha = 0.75
) +
scale_color_viridis(
option = "mako",
name = "Average Demand (Trips per 30-Min)",
direction = -1
) +
labs(
title = "Average Station Demand",
subtitle = "Trips per Station-30-Min (2024 Q4 Test Set)"
) +
theme_map()
# Display maps side by side.
pred_error_q4_map | avg_dem_q4_map
#| message: false
#| warning: false
#| fig-dpi: 300
#| fig-height: 8
#| fig-width: 12
# Create scatter plot of observed vs predicted.
obs_vs_pred_plot <- ggplot(test_q4_error, aes(x = trips, y = model2_q4_pred)) +
# Plot points with transparency to show density.
geom_point(alpha = 0.25, color = "#1492D3") +
# Add 45-degree line perfect predictions.
geom_abline(slope = 1, intercept = 0, color = "#F03E36", linewidth = 1, linetype = "dashed") +
# Add OLS fit line to show systematic bias.
geom_smooth(method = "lm", se = FALSE, color = "#00a557", linetype = "dashed") +
# Facet by weekend and time of day.
facet_grid(is_weekend ~ time_of_day) +
labs(
title = "Observed vs. Predicted Bike Trips (2024 Q4 Model 2)",
subtitle = "Red Line = Perfect Predictions\nGreen Line = OLS Fit",
caption = "Performance grouped by time of day and weekday / weekend.",
x = "Observed Trips (Trips per 30-Min)",
y = "Predicted Trips (Model 2)"
) +
theme_plot() +
theme(
axis.text.x = element_text(hjust = 1, size = 20),
legend.position = "none",
strip.text = element_text(
face = "bold",
size = 20,
family = "anonymous",
color = "#2d2a26"
)
)
obs_vs_pred_plot
#| fig-height: 8
#| fig-width: 12
#| fig-dpi: 300
# Calculate MAE by time period and day type.
temporal_errors_q4 <- test_q4_error %>%
group_by(time_of_day, is_weekend) %>%
summarize(
MAE = mean(abs_error, na.rm = TRUE),
.groups = "drop"
) %>%
# Day type label.
mutate(day_type = ifelse(is_weekend, "Weekend", "Weekday"))
# Bar plot of temporal errors.
temp_error_plot <- ggplot(temporal_errors_q4, aes(x = time_of_day, y = MAE, fill = day_type)) +
# Dodged bars to compare weekday vs weekend.
geom_col(position = "dodge",
colour = "#3d3b3c",
linewidth = 1) +
# Add value labels on top of bars.
geom_text(
aes(label = round(mae, 3)),
vjust = -0.3,
size = 18,
color = "#2d2a26",
family = "anonymous"
) +
# Colors for day types.
scale_fill_manual(values = c("Weekday" = "#f6a2a7", "Weekend" = "#8bcef2")) +
labs(
title = "Prediction Errors by Time Period",
subtitle = "2024 Q4",
caption = "MAE is highest during commuter peaks.",
x = "Time of Day",
y = "Mean Absolute Error (Trips)",
fill = "Day Type"
) +
theme_plot() +
# Angle labels.
theme(axis.text.x = element_text(angle = 45, hjust = 1))
temp_error_plot
#| fig-height: 8
#| fig-width: 12
#| fig-dpi: 300
# Calculate MAE by time period and day type.
temporal_errors_q4 <- test_q4_error %>%
group_by(time_of_day, is_weekend) %>%
summarize(
mae = mean(abs_error, na.rm = TRUE),
.groups = "drop"
) %>%
# Day type label.
mutate(day_type = ifelse(is_weekend, "Weekend", "Weekday"))
# Bar plot of temporal errors.
temp_error_plot <- ggplot(temporal_errors_q4, aes(x = time_of_day, y = MAE, fill = day_type)) +
# Dodged bars to compare weekday vs weekend.
geom_col(position = "dodge",
colour = "#3d3b3c",
linewidth = 1) +
# Add value labels on top of bars.
geom_text(
aes(label = round(mae, 3)),
vjust = -0.3,
size = 18,
color = "#2d2a26",
family = "anonymous"
) +
# Colors for day types.
scale_fill_manual(values = c("Weekday" = "#f6a2a7", "Weekend" = "#8bcef2")) +
labs(
title = "Prediction Errors by Time Period",
subtitle = "2024 Q4",
caption = "MAE is highest during commuter peaks.",
x = "Time of Day",
y = "Mean Absolute Error (Trips)",
fill = "Day Type"
) +
theme_plot() +
# Angle labels.
theme(axis.text.x = element_text(angle = 45, hjust = 1))
temp_error_plot
#| fig-height: 8
#| fig-width: 12
#| fig-dpi: 300
# Calculate MAE by time period and day type.
temporal_errors_q4 <- test_q4_error %>%
group_by(time_of_day, is_weekend) %>%
summarize(
mae = mean(abs_error, na.rm = TRUE),
.groups = "drop"
) %>%
# Day type label.
mutate(day_type = ifelse(is_weekend, "Weekend", "Weekday"))
# Bar plot of temporal errors.
temp_error_plot <- ggplot(temporal_errors_q4, aes(x = time_of_day, y = MAE, fill = day_type)) +
# Dodged bars to compare weekday vs weekend.
geom_col(position = "dodge",
colour = "#3d3b3c",
linewidth = 1) +
# Add value labels on top of bars.
geom_text(
aes(label = round(mae, 3)),
vjust = -0.3,
size = 18,
color = "#2d2a26",
family = "anonymous"
) +
# Colors for day types.
scale_fill_manual(values = c("Weekday" = "#f6a2a7", "Weekend" = "#8bcef2")) +
labs(
title = "Prediction Errors by Time Period",
subtitle = "2024 Q4",
caption = "MAE is highest during commuter peaks.",
x = "Time of Day",
y = "Mean Absolute Error (Trips)",
fill = "Day Type"
) +
theme_plot() +
# Angle labels.
theme(axis.text.x = element_text(angle = 45, hjust = 1))
temp_error_plot
#| fig-height: 8
#| fig-width: 12
#| fig-dpi: 300
# Calculate MAE by time period and day type.
temporal_errors_q4 <- test_q4_error %>%
group_by(time_of_day, is_weekend) %>%
summarize(
MAE = mean(abs_error, na.rm = TRUE),
.groups = "drop"
) %>%
# Day type label.
mutate(day_type = ifelse(is_weekend, "Weekend", "Weekday"))
# Bar plot of temporal errors.
temp_error_plot <- ggplot(temporal_errors_q4, aes(x = time_of_day, y = MAE, fill = day_type)) +
# Dodged bars to compare weekday vs weekend.
geom_col(position = "dodge",
colour = "#3d3b3c",
linewidth = 1) +
# Add value labels on top of bars.
geom_text(
aes(label = round(MAE, 3)),
vjust = -0.3,
size = 18,
color = "#2d2a26",
family = "anonymous"
) +
# Colors for day types.
scale_fill_manual(values = c("Weekday" = "#f6a2a7", "Weekend" = "#8bcef2")) +
labs(
title = "Prediction Errors by Time Period",
subtitle = "2024 Q4",
caption = "MAE is highest during commuter peaks.",
x = "Time of Day",
y = "Mean Absolute Error (Trips)",
fill = "Day Type"
) +
theme_plot() +
# Angle labels.
theme(axis.text.x = element_text(angle = 45, hjust = 1))
temp_error_plot
