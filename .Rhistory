percent_underserved = (number_underserved / number_vulnerable) * 100,
# Summarize the average distance to the nearest hospital.
avg_nearby_hospital_dist = mean(nearest_hospital_mi, na.rm = TRUE),
# Summarize the total estimated population.
total_vulnerable_pop = sum(total_popE)
) %>%
# Rename the NAMELSADCO column to county.
rename(
county = NAMELSADCO
)
# Change COUNTY_NAM to county.
pa_counties <- rename(pa_counties, county = COUNTY_NAM)
# Conduct a left join.
pa_mapping <- left_join(pa_counties, aggregate_summary, by = "county")
# Plot map of percent underserved by Pennsylvania counties.
ggplot(pa_mapping) +
geom_sf(aes(fill = percent_underserved), color = "white", size = 0.5) +
scale_fill_viridis_c(
name = "Percent Underserved",
option = "magma",
# Format to show percent sign on color bar.
labels = function(x) paste0(x, "%")
) +
labs(
title = "Most Underserved Counties",
subtitle = "Pennsylvania, United States",
caption = "Source: ACS 2019–2023"
) +
theme_void()
# Create and format priority counties table.
kable_table <- pa_mapping[, c("county", "number_vulnerable",
"number_underserved", "percent_underserved",
"avg_nearby_hospital_dist", "total_vulnerable_pop")]
# Drop geometry and rename the columns.
kable_table <- kable_table %>%
st_drop_geometry() %>%
rename(
"County" = county,
"Number of Vulnerable Tracts" = number_vulnerable,
"Number of Underserved Tracts" = number_underserved,
"Percent Underserved" = percent_underserved,
"Average Mile(s) to Nearest Hospital" = avg_nearby_hospital_dist,
"Total Vulnerable People" = total_vulnerable_pop
)
# Filter and arrage the top 10 underserved counties by percent.
kable_table <- kable_table %>%
arrange(desc(`Percent Underserved`)) %>%
slice(1:10)
# Format percent column to have % sign.
kable_table <- kable_table %>%
mutate(
# Format so percent and distance values have units.
`Percent Underserved` = paste0(round(`Percent Underserved`, 2), "%"),
`Average Mile(s) to Nearest Hospital` = paste0(round(`Average Mile(s) to Nearest Hospital`, 2), " mi")
)
# Create kable.
kable(
kable_table,
# Center align.
align = "c",
# Limit percents to two decimal places.
digit = 2,
# Make sure numbers are separated by thousands places.
format.args = list(big.mark = ","),
caption = "<b>TOP 10 UNDERSERVED PA COUNTIES: For Priority Healthcare Investment</b>"
) %>%
# Shade every other row for ease of reading.
kable_styling(bootstrap_options = "striped") %>%
column_spec(1, bold = TRUE) %>%
row_spec(0, color = "mistyrose", background = "red3")
# Create county-level access map.
# Align CRS.
pa_hospitals <- st_transform(pa_hospitals, crs = 4326)
pa_mapping <- st_transform(pa_mapping, crs = 4326)
# Choropleth map of PA counties.
choropleth_pa <- ggplot(pa_mapping) +
geom_sf(
# Color by underserved percentage.
aes(fill = percent_underserved),
color = "white",
linewidth = 0.25
) +
scale_fill_viridis_c(
# Color bar customization.
name = "Percent Underserved",
option = "viridis",
# Format to show percent sign in color bar.
labels = function(x) paste0(x, "%")
) +
geom_point(
data = pa_hospitals,
aes(x = LONGITUDE, y = LATITUDE, color = "Hospitals"),
alpha = 0.75, inherit.aes = FALSE
) +
scale_color_manual(
name = "Hospitals",
values = c("Hospitals" = "red")
) +
labs(
title = "UNDERSERVED COUNTIES & HOSPITAL LOCATIONS",
subtitle = "Pennsylvania, United States",
caption = "Source: 5-Year American Community Survey (ACS) 2019–2023",
) +
theme_void()
choropleth_pa + theme(
legend.box.margin = margin(l = 10, unit = "pt"),
legend.title = element_text(face = "bold"),
legend.text = element_text(family = "mono"),
plot.title = element_text(face = "bold"),
plot.subtitle = element_text(margin = margin(b = 10, t = 5, unit = "pt")),
plot.caption = element_text(margin = margin(t = 10, unit = "pt"), face = "italic", family = "mono")
)
# Create detailed tract-level map.
# Align CRS.
vulnerable_tracts <- st_transform(vulnerable_tracts, crs = 4326)
pa_tracts <- st_transform(pa_tracts, crs = 4326)
# Filter by underserved tracts.
vulnerable_tracts <- vulnerable_tracts %>%
rename("Underserved Tracts" = underserved)
# Choropleth map of PA census tracts colored by vulnerable and underserved.
choropleth_map <- ggplot(vulnerable_tracts) +
geom_sf(
aes(fill = `Underserved Tracts`),
) +
geom_sf(
data = pa_tracts, fill = NA,
color = "midnightblue", linewidth = 0.25
) +
geom_sf(
data = pa_counties, fill = NA,
color = "midnightblue", linewidth = 0.5
) +
geom_point(
data = pa_hospitals,
aes(x = LONGITUDE, y = LATITUDE, color = "Hospitals"),
alpha = 0.75, inherit.aes = FALSE
) +
scale_fill_manual(
# Custom color bar.
name = "Tracts",
values = c("TRUE" = "gold2", "FALSE" = "lemonchiffon2"),
labels = c("TRUE" = "Underserved", "FALSE" = "Vulnerable"),
# Reorder so that underserved is placed above vulnerable in the legend.
breaks = c(TRUE, FALSE)
) +
scale_color_manual(
# Custom point addition to legend.
name = "Hospitals",
values = c("Hospitals" = "red2")
) +
labs(
title = "UNDERSERVED AND VULNERABLE CENSUS TRACTS",
subtitle = "With Hospital Locations in Pennsylvania, United States",
caption = "Source: 5-Year American Community Survey (ACS) 2019–2023",
) +
theme_void()
choropleth_map + theme(
panel.background = element_rect(fill = "azure3", size = 0.75),
legend.box.margin = margin(l = 10, unit = "pt"),
legend.title = element_text(face = "bold"),
legend.text = element_text(family = "mono"),
plot.title = element_text(face = "bold"),
plot.subtitle = element_text(margin = margin(b = 10, t = 5, unit = "pt")),
plot.caption = element_text(margin = margin(t = 10, unit = "pt"), face = "italic", family = "mono")
)
# Create distribution visualization.
# Make histogram of distance to nearest hospital.
histogram_hospital <- ggplot(vulnerable_tracts, aes(x = nearest_hospital_mi)) +
geom_histogram(
color = "black",
fill = "mistyrose2"
) +
labs(
title = "DISTANCE TO NEAREST HOSPITAL",
subtitle = "Histogram",
x = "Distance to Nearest Hospital (mi)",
y = "Count") +
theme_minimal() +
scale_x_continuous(labels = scales::label_number(suffix = " mi")) + # Format so tick numbers have miles at end.
theme(aspect.ratio = 1/3) # Maintain aspect ratio.
# Make histogram of elderly population.
histogram_elderly <- ggplot(vulnerable_tracts, aes(x = age_65_overE)) +
geom_histogram(
color = "black",
fill = "mistyrose2"
) +
# Thousand separator.
scale_x_continuous(labels = comma) +
labs(
title = "VULNERABLE POPULATION OF AGES 65+",
subtitle = "Histogram",
x = "Population of Ages 65+",
y = "Count") +
theme_minimal() +
theme(aspect.ratio = 1/3) # Maintain aspect ratio.
# Create faceted plot of all three charts above in one column and three rows.
faceted_plot <-
(histogram_hospital + theme(
# Customize margins and text.
plot.title = element_text(margin = margin(b = 10, unit = "pt"), face = "bold"),
axis.title.x = element_text(margin = margin(t = 10, unit = "pt")),
axis.title.y = element_text(margin = margin(r = 10, unit = "pt"))
)) /
(histogram_elderly + theme(
# Customize margins and text.
plot.title = element_text(margin = margin(t = 20, b = 10, unit = "pt"), face = "bold"),
axis.title.x = element_text(margin = margin(t = 10, unit = "pt")),
axis.title.y = element_text(margin = margin(r = 10, unit = "pt"))
))
# Display faceted plot.
faceted_plot
#| message: false
#| include: false
# All data from OpenDataPhilly.
# Substance-related point data.
# No creation date, GitHub indicates data was posted 2 years ago.
sharps_boxes <- st_read("data/sharps_drop_boxes/sharps_drop_boxes.shp")
# Created December 1, 2022.
treatment_facilities <- st_read("data/treatment_facilities/treatment_facilities.shp")
# Food point data.
# No creation date, GitHub indicates data was posted 11 months ago.
free_meal_sites <- st_read("data/free_meal_sites/free_meal_sites.shp")
# Crime point data.
# 2024 crime statistics to have more temporal alignment with other data sets.
crime_2024 <- read.csv("data/crime_2024.csv")
# Boundary data filtered to Philadelphia.
philly_county <- pa_counties %>%
filter(`county` == "PHILADELPHIA")
philly_tracts <- pa_tracts %>%
filter(`NAMELSADCO` == "Philadelphia County")
# CRS checks and transformations.
# Change data CRS to Pennsylvania South (EPSG 3365) for calculations.
sharps_boxes <- sharps_boxes %>%
st_transform(crs = 3365)
treatment_facilities <- treatment_facilities %>%
st_transform(crs = 3365)
free_meal_sites <- free_meal_sites %>%
st_transform(crs = 3365)
philly_county <- philly_county %>%
st_transform(crs = 3365)
philly_tracts <- philly_tracts %>%
st_transform(crs = 3365)
crime_2024 <- crime_2024 %>%
# Remove points where latitude and longitude are NA or empty.
.[!(is.na(.$lng) | .$lng == "" | is.na(.$lat) | .$lat == ""),] %>%
# Change to spatial dataframe and set CRS to 4326 because of coordinate data.
st_as_sf(., coords = c("lng", "lat"), crs = 4326) %>%
# Change to needed CRS for calculations.
st_transform(crs = 3365)
# Filter 2024 crime data by substance-related uses.
substances_2024 <- crime_2024 %>%
filter(`text_general_code` == "Narcotic / Substance Law Violations")
# Clean data, filter, and remove unneeded columns.
sharps_boxes[, c("OBJECTID", "OBJECTID_1", "SITE_NAME", "SUB_NAME", "STATE")] <- list(NULL)
# Filter to Philadelphia
treatment_facilities <- treatment_facilities %>%
filter(`COUNTY` == "PHILADELPHIA")
treatment_facilities[, c("OBJECTID", "FACILITY_I", "GEOCODING_", "STREET_2", "CITY", "STATE", "TELEPHONE_")] <- list(NULL)
# Filter to active sites.
free_meal_sites <- free_meal_sites %>%
filter(`status` == "Active")
free_meal_sites[, c("objectid", "phone_numb", "temporary_", "site_key", "website", "hours_mon_", "hours_tues", "hours_wed_", "hours_thur", "hours_fri_", "hours_sat_", "hours_sa_1", "hours_sa_2", "hours_sun_", "email", "seasonally")] <- list(NULL)
substances_2024[, c("the_geom", "cartodb_id", "the_geom_webmercator", "objectid", "dc_dist", "psa", "dispatch_date_time", "dispatch_date", "dispatch_time", "hour", "dc_key", "ucr_general")] <- list(NULL)
philly_tracts[, c("STATEFP", "COUNTYFP", "GEOIDFQ", "NAME", "NAMELSAD", "STUSPS", "TRACTCE", "STATE_NAME", "LSAD", "TRACT")] <- list(NULL)
colnames(philly_tracts)[2] <- "county"
# Aggregate and count substance use in Philadelphia census tracts.
# Use pipe to input st_intersects return values into lengths() function.
philly_tracts$substance_use <- st_intersects(philly_tracts, substances_2024) |> lengths()
# Normalize substance use data by population total.
philly_tracts <- philly_tracts %>%
mutate(pct_substance_use = case_when(
# Calculate as 0 when both values are 0.
total_popE == 0 & substance_use == 0 ~ 0,
# Calculate as NA with numeric type rather than NA with logical type to avoid type mismatch.
total_popE == 0 ~ NA_real_,
# Otherwise, calculate normally.
TRUE ~ (substance_use / total_popE) * 100
))
# Determine high substance use tracts as above 50% of bell curve.
philly_tracts <- philly_tracts %>%
mutate("high_substance_use" = case_when(
.$pct_substance_use > 0.20539 ~ TRUE,
TRUE ~ FALSE
))
# Filter tracts with substance uses above the median.
substance_tracts <- philly_tracts %>%
filter(.$high_substance_use == TRUE)
#| warning: false
# Create census tract centroids for substance_tracts.
substance_centroids <- st_centroid(substance_tracts)
# Calculate distances between centroids and food accessibility.
nearest_meal_index <- st_nearest_feature(substance_centroids, free_meal_sites)
nearest_meal_point <- free_meal_sites[nearest_meal_index,]
meal_distance <- st_distance(substance_centroids, nearest_meal_point, by_element = TRUE)
#| warning: false
# Create census tract centroids for substance_tracts.
substance_centroids <- st_centroid(substance_tracts)
# Calculate distances between centroids and food accessibility.
nearest_meal_index <- st_nearest_feature(substance_centroids, free_meal_sites)
nearest_meal_point <- free_meal_sites[nearest_meal_index,]
# **FIX:** Coerce to vector
meal_distance <- as.vector(st_distance(substance_centroids, nearest_meal_point, by_element = TRUE))
#| warning: false
# Create census tract centroids for substance_tracts.
substance_centroids <- st_centroid(substance_tracts)
# Calculate distances between centroids and food accessibility.
nearest_meal_index <- st_nearest_feature(substance_centroids, free_meal_sites)
nearest_meal_point <- free_meal_sites[nearest_meal_index,]
# Coerce to vector
meal_distance <- as.vector(st_distance(substance_centroids, nearest_meal_point, by_element = TRUE))
#| warning: false
# Create census tract centroids for substance_tracts.
substance_centroids <- st_centroid(substance_tracts)
# Calculate distances between centroids and food accessibility.
nearest_meal_index <- st_nearest_feature(substance_centroids, free_meal_sites)
nearest_meal_point <- free_meal_sites[nearest_meal_index,]
# FIX: Extract geometry explicitly and drop units before assignment
meal_distance <- st_distance(st_geometry(substance_centroids),
st_geometry(nearest_meal_point),
by_element = TRUE)
#| warning: false
# Create census tract centroids for substance_tracts.
substance_centroids <- st_centroid(substance_tracts)
# Calculate distances between centroids and food accessibility.
nearest_meal_index <- st_nearest_feature(substance_centroids, free_meal_sites)
# FIX: Use st_geometry() when subsetting to ensure proper geometry extraction
nearest_meal_geom <- st_geometry(free_meal_sites)[nearest_meal_index]
meal_distance <- st_distance(st_geometry(substance_centroids),
nearest_meal_geom,
by_element = TRUE)
# Aggregate and count substance use in Philadelphia census tracts.
# Use pipe to input st_intersects return values into lengths() function.
philly_tracts$substance_use <- st_intersects(philly_tracts, substances_2024) |> lengths()
# Normalize substance use data by population total.
philly_tracts <- philly_tracts %>%
mutate(pct_substance_use = case_when(
# Calculate as 0 when both values are 0.
total_popE == 0 & substance_use == 0 ~ 0,
# Calculate as NA with numeric type rather than NA with logical type to avoid type mismatch.
total_popE == 0 ~ NA_real_,
# Otherwise, calculate normally.
TRUE ~ (substance_use / total_popE) * 100
))
# Determine high substance use tracts as above 50% of bell curve.
philly_tracts <- philly_tracts %>%
mutate("high_substance_use" = case_when(
.$pct_substance_use > 0.20539 ~ TRUE,
TRUE ~ FALSE
))
# Filter tracts with substance uses above the median.
substance_tracts <- philly_tracts %>%
filter(.$high_substance_use == TRUE)
#| warning: false
# Create census tract centroids for substance_tracts.
substance_centroids <- st_centroid(substance_tracts)
# Calculate distances between centroids and food accessibility.
nearest_meal_index <- st_nearest_feature(substance_centroids, free_meal_sites)
# FIX: Use st_geometry() when subsetting to ensure proper geometry extraction
nearest_meal_geom <- st_geometry(free_meal_sites)[nearest_meal_index]
meal_distance <- st_distance(st_geometry(substance_centroids),
nearest_meal_geom,
by_element = TRUE)
#| warning: false
# Create census tract centroids for substance_tracts.
substance_centroids <- st_centroid(substance_tracts)
# Calculate distances between centroids and food accessibility.
nearest_meal_index <- st_nearest_feature(substance_centroids, free_meal_sites)
# FIX: Extract just the sfc geometry column by indexing
nearest_meal_geom <- st_geometry(free_meal_sites)[nearest_meal_index]
meal_distance <- st_distance(st_geometry(substance_centroids),
nearest_meal_geom,
by_element = TRUE)
print(class(st_geometry(free_meal_sites)))
print(class(st_geometry(treatment_facilities)))
print(class(st_geometry(sharps_boxes)))
#| warning: false
# Create census tract centroids for substance_tracts.
substance_centroids <- st_centroid(substance_tracts)
# Calculate distances between centroids and food accessibility.
nearest_meal_index <- st_nearest_feature(substance_centroids, free_meal_sites)
meal_distance <- st_distance(substance_centroids, free_meal_sites[nearest_meal_index,], by_element = TRUE)
#| warning: false
# Create census tract centroids for substance_tracts.
substance_centroids <- st_centroid(substance_tracts)
# Calculate distances between centroids and food accessibility.
nearest_meal_index <- st_nearest_feature(substance_centroids, free_meal_sites)
meal_distance <- st_distance(substance_centroids, free_meal_sites[nearest_meal_index,], by_element = TRUE)
free_meal_sites
#| warning: false
# Create census tract centroids for substance_tracts.
substance_centroids <- st_centroid(substance_tracts)
# Calculate distances between centroids and food accessibility.
nearest_meal_index <- st_nearest_feature(substance_centroids, free_meal_sites)
meal_distance <- st_distance(substance_centroids, free_meal_sites[nearest_meal_index,], by_element = TRUE)
free_meal_sites
substance_centroids
#| message: false
#| include: false
# All data from OpenDataPhilly.
# Substance-related point data.
# No creation date, GitHub indicates data was posted 2 years ago.
sharps_boxes <- st_read("data/sharps_drop_boxes/sharps_drop_boxes.shp")
# Created December 1, 2022.
treatment_facilities <- st_read("data/treatment_facilities/treatment_facilities.shp")
# Food point data.
# No creation date, GitHub indicates data was posted 11 months ago.
free_meal_sites <- st_read("data/free_meal_sites/free_meal_sites.shp")
# Crime point data.
# 2024 crime statistics to have more temporal alignment with other data sets.
crime_2024 <- read.csv("data/crime_2024.csv")
# Boundary data filtered to Philadelphia.
philly_county <- pa_counties %>%
filter(`county` == "PHILADELPHIA")
philly_tracts <- pa_tracts %>%
filter(`NAMELSADCO` == "Philadelphia County")
# CRS checks and transformations.
# Change data CRS to Pennsylvania South (EPSG 3365) for calculations.
sharps_boxes <- sharps_boxes %>%
st_transform(crs = 3365)
treatment_facilities <- treatment_facilities %>%
st_transform(crs = 3365)
free_meal_sites <- free_meal_sites %>%
st_transform(crs = 3365)
philly_county <- philly_county %>%
st_transform(crs = 3365)
philly_tracts <- philly_tracts %>%
st_transform(crs = 3365)
crime_2024 <- crime_2024 %>%
# Remove points where latitude and longitude are NA or empty.
.[!(is.na(.$lng) | .$lng == "" | is.na(.$lat) | .$lat == ""),] %>%
# Change to spatial dataframe and set CRS to 4326 because of coordinate data.
st_as_sf(., coords = c("lng", "lat"), crs = 4326) %>%
# Change to needed CRS for calculations.
st_transform(crs = 3365)
# Filter 2024 crime data by substance-related uses.
substances_2024 <- crime_2024 %>%
filter(`text_general_code` == "Narcotic / Substance Law Violations")
substances_2024
crime_2024
# Filter 2024 crime data by substance-related uses.
substances_2024 <- crime_2024 %>%
filter(text_general_code == "Narcotic / Substance Law Violations")
# CRS checks and transformations.
# Change data CRS to Pennsylvania South (EPSG 3365) for calculations.
sharps_boxes <- sharps_boxes %>%
st_transform(crs = 3365)
treatment_facilities <- treatment_facilities %>%
st_transform(crs = 3365)
free_meal_sites <- free_meal_sites %>%
st_transform(crs = 3365)
philly_county <- philly_county %>%
st_transform(crs = 3365)
philly_tracts <- philly_tracts %>%
st_transform(crs = 3365)
crime_2024 <- crime_2024 %>%
# Remove points where latitude and longitude are NA or empty.
.[!(is.na(.$lng) | .$lng == "" | is.na(.$lat) | .$lat == ""),] %>%
# Change to spatial dataframe and set CRS to 4326 because of coordinate data.
st_as_sf(., coords = c("lng", "lat"), crs = 4326) %>%
# Change to needed CRS for calculations.
st_transform(crs = 3365)
# Filter 2024 crime data by substance-related uses.
substances_2024 <- crime_2024 %>%
filter(text_general_code == "Narcotic / Substance Law Violations")
substances_2024
crime_2024
#| message: false
#| include: false
# All data from OpenDataPhilly.
# Substance-related point data.
# No creation date, GitHub indicates data was posted 2 years ago.
sharps_boxes <- st_read("data/sharps_drop_boxes/sharps_drop_boxes.shp")
# Created December 1, 2022.
treatment_facilities <- st_read("data/treatment_facilities/treatment_facilities.shp")
# Food point data.
# No creation date, GitHub indicates data was posted 11 months ago.
free_meal_sites <- st_read("data/free_meal_sites/free_meal_sites.shp")
# Crime point data.
# 2024 crime statistics to have more temporal alignment with other data sets.
crime_2024 <- read.csv("data/crime_2024.csv")
# Boundary data filtered to Philadelphia.
philly_county <- pa_counties %>%
filter(`county` == "PHILADELPHIA")
philly_tracts <- pa_tracts %>%
filter(`NAMELSADCO` == "Philadelphia County")
# CRS checks and transformations.
# Change data CRS to Pennsylvania South (EPSG 3365) for calculations.
sharps_boxes <- sharps_boxes %>%
st_transform(crs = 3365)
treatment_facilities <- treatment_facilities %>%
st_transform(crs = 3365)
free_meal_sites <- free_meal_sites %>%
st_transform(crs = 3365)
philly_county <- philly_county %>%
st_transform(crs = 3365)
philly_tracts <- philly_tracts %>%
st_transform(crs = 3365)
crime_2024 <- crime_2024 %>%
# Remove points where latitude and longitude are NA or empty.
.[!(is.na(.$lng) | .$lng == "" | is.na(.$lat) | .$lat == ""),] %>%
# Change to spatial dataframe and set CRS to 4326 because of coordinate data.
st_as_sf(., coords = c("lng", "lat"), crs = 4326) %>%
# Change to needed CRS for calculations.
st_transform(crs = 3365)
# Filter 2024 crime data by substance-related uses.
substances_2024 <- crime_2024 %>%
filter(text_general_code == "Narcotic / Substance Law Violations")
crime_2024
substances_2024
crime_2024
names(crime_2024$text_general_code)
unique(crime_2024$text_general_code)
